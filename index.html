import React, { useEffect, useMemo, useRef, useState } from "react";
import { initializeApp, type FirebaseApp } from "firebase/app";
import {
  getDatabase,
  ref,
  child,
  onValue,
  update,
  get,
  type Database,
  serverTimestamp,
} from "firebase/database";
import {
  getAuth,
  signInAnonymously,
  onAuthStateChanged,
  type User,
} from "firebase/auth";

// =============== CONFIG =================
// Replace with your project if needed
const firebaseConfig = {
  apiKey: "AIzaSyCbXxL7mv9U10MxYkdNsVQrijrpsVGoGU0",
  authDomain: "self-destruct-console.firebaseapp.com",
  databaseURL:
    "https://self-destruct-console-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "self-destruct-console",
  storageBucket: "self-destruct-console.firebasestorage.app",
  messagingSenderId: "669939099742",
  appId: "1:669939099742:web:310269ae940dd68a84accf",
};

// =============== TYPES ==================
type Status = "IDLE" | "ARMED" | "COUNTDOWN" | "ABORTED" | "DETONATED";

type PublicState = {
  status: Status;
  since: number | null;
  startAt: number | null;
  durationMs: number;
  armedAt: number | null;
  logPublic: string[];
};

type Officer = { name: string; pinHash: string | null };

type SecurityState = {
  operatorUid: string | null;
  operatorSince?: number | null;
  pinHash: string | null;
  recoveryHash: string | null;
  officers: { o1?: Officer; o2?: Officer };
  lockoutUntil?: number | null;
  lockoutReason?: string | null;
};

// =============== UTILS ===================
const pad2 = (n: number) => String(n).padStart(2, "0");
const fmt = (ms: number) => {
  if (ms < 0) ms = 0;
  const t = Math.floor(ms / 1000),
    h = Math.floor(t / 3600),
    m = Math.floor((t % 3600) / 60),
    s = t % 60;
  return (h ? pad2(h) + ":" : "") + pad2(m) + ":" + pad2(s);
};
async function sha256(str: string) {
  const buf = new TextEncoder().encode(str);
  const h = await crypto.subtle.digest("SHA-256", buf);
  return Array.from(new Uint8Array(h))
    .map((b) => b.toString(16).padStart(2, "0"))
    .join("");
}

// =========== FIREBASE BOOTSTRAP ===========
function useFirebase() {
  const appRef = useRef<FirebaseApp>();
  const dbRef = useRef<Database>();
  const [user, setUser] = useState<User | null>(null);
  const [connected, setConnected] = useState<boolean>(false);

  useEffect(() => {
    const app = initializeApp(firebaseConfig);
    appRef.current = app;
    const db = getDatabase(app);
    dbRef.current = db;

    const auth = getAuth(app);
    signInAnonymously(auth).catch(() => {});
    const unsubAuth = onAuthStateChanged(auth, (u) => setUser(u));

    const connRef = ref(db, ".info/connected");
    const unsubConn = onValue(connRef, (s) => setConnected(s.val() === true));

    return () => {
      unsubAuth();
      unsubConn();
    };
  }, []);

  return { app: appRef.current, db: dbRef.current, user, connected };
}

// =============== DATA HOOKS ===============
function usePublic(db?: Database) {
  const [pub, setPub] = useState<PublicState>({
    status: "IDLE",
    since: null,
    startAt: null,
    durationMs: 0,
    armedAt: null,
    logPublic: [],
  });
  useEffect(() => {
    if (!db) return;
    const base = ref(db, "selfDestruct/public");
    const unsub = [
      onValue(child(base, "status"), (s) =>
        setPub((p) => ({ ...p, status: (s.val() as Status) ?? "IDLE" }))
      ),
      onValue(child(base, "since"), (s) =>
        setPub((p) => ({ ...p, since: s.val() ?? null }))
      ),
      onValue(child(base, "startAt"), (s) =>
        setPub((p) => ({ ...p, startAt: s.val() ?? null }))
      ),
      onValue(child(base, "durationMs"), (s) =>
        setPub((p) => ({ ...p, durationMs: s.val() ?? 0 }))
      ),
      onValue(child(base, "armedAt"), (s) =>
        setPub((p) => ({ ...p, armedAt: s.val() ?? null }))
      ),
      onValue(child(base, "logPublic"), (s) =>
        setPub((p) => ({ ...p, logPublic: Array.isArray(s.val()) ? s.val() : [] }))
      ),
    ];
    return () => unsub.forEach((u) => u());
  }, [db]);
  return pub;
}

function useSecurity(db?: Database, uid?: string | null) {
  const [sec, setSec] = useState<SecurityState>({
    operatorUid: null,
    pinHash: null,
    recoveryHash: null,
    officers: {},
    lockoutUntil: null,
    lockoutReason: null,
  });
  const isOperator = useMemo(
    () => !!uid && sec.operatorUid === uid,
    [uid, sec.operatorUid]
  );
  useEffect(() => {
    if (!db) return;
    const base = ref(db, "selfDestruct/security");
    return onValue(base, (s) => setSec((s.val() as SecurityState) || sec));
  }, [db]);
  return { sec, isOperator };
}

function useProbe(db?: Database, isOperator?: boolean) {
  const [operatorCapable, setOpCap] = useState(false);
  useEffect(() => {
    if (!db) return;
    const pr = ref(db, "selfDestruct/updateProbe");
    let timer: any;
    async function tick() {
      try {
        await update(pr, { t: Date.now() });
        setOpCap(true);
      } catch {
        setOpCap(false);
      }
    }
    tick();
    timer = setInterval(tick, 5000);
    return () => clearInterval(timer);
  }, [db, isOperator]);
  return operatorCapable;
}

// ============ ACTIONS (DB writes) ============
function useActions(db?: Database, user?: User | null) {
  const pubRef = useMemo(() => (db ? ref(db, "selfDestruct/public") : undefined), [db]);
  const secRef = useMemo(() => (db ? ref(db, "selfDestruct/security") : undefined), [db]);
  const uid = user?.uid;

  async function appendLog(line: string) {
    if (!db || !pubRef) return;
    const snap = await get(child(pubRef, "logPublic"));
    const arr: string[] = Array.isArray(snap.val()) ? snap.val() : [];
    arr.push(`${new Date().toLocaleString()} â€” ${line}`);
    await update(pubRef, { logPublic: arr });
  }

  return {
    async claimOperator() {
      if (!db || !secRef || !uid) return { ok: false, msg: "No auth" };
      const s = await get(secRef);
      const cur = (s.val() as SecurityState) || {};
      if (!cur.operatorUid) {
        await update(secRef, { operatorUid: uid, operatorSince: Date.now() });
        return { ok: true };
      }
      if (cur.operatorUid === uid) return { ok: true, msg: "Already operator" };
      return { ok: false, msg: "Operator already set" };
    },

    async resetOperator() {
      if (!secRef) return;
      await update(secRef, { operatorUid: null });
    },

    async setPin(pin: string) {
      if (!secRef) return { ok: false };
      const h = await sha256(pin);
      await update(secRef, { pinHash: h });
      return { ok: true };
    },

    async genToken() {
      if (!secRef) return { ok: false };
      const bytes = new Uint8Array(24);
      crypto.getRandomValues(bytes);
      const token = btoa(String.fromCharCode(...bytes));
      const h = await sha256(token);
      await update(secRef, { recoveryHash: h });
      return { ok: true, token };
    },

    async rekeyWithToken(token: string) {
      if (!secRef || !uid) return { ok: false };
      const s = await get(secRef);
      const cur = (s.val() as SecurityState) || {};
      const h = await sha256(token);
      if (!cur.recoveryHash || h !== cur.recoveryHash)
        return { ok: false, msg: "Invalid token" };
      await update(secRef, {
        operatorUid: uid,
        operatorSince: Date.now(),
        recoveryHash: null,
      });
      return { ok: true };
    },

    async saveOfficers(o1: Officer, o2: Officer) {
      if (!secRef) return { ok: false };
      await update(child(secRef, "officers"), { o1, o2 });
      return { ok: true };
    },

    async verifyOfficers(i1Name: string, i1Pin: string, i2Name: string, i2Pin: string) {
      if (!secRef) return false;
      const s = await get(secRef);
      const v = (s.val() as SecurityState) || {};
      const off = v.officers || {};
      const h1 = i1Pin ? await sha256(i1Pin) : "";
      const h2 = i2Pin ? await sha256(i2Pin) : "";
      const ok1 = !!off.o1 && (off.o1.name || "") === i1Name && (off.o1.pinHash || "") === h1;
      const ok2 = !!off.o2 && (off.o2.name || "") === i2Name && (off.o2.pinHash || "") === h2;
      return ok1 && ok2;
    },

    async arm(i1Name: string, i1Pin: string, i2Name: string, i2Pin: string) {
      if (!pubRef) return { ok: false };
      const ok = await this.verifyOfficers(i1Name, i1Pin, i2Name, i2Pin);
      if (!ok) return { ok: false, msg: "Officer verification failed" };
      await update(pubRef, { status: "ARMED", since: Date.now(), armedAt: Date.now() });
      await appendLog("ARMED");
      return { ok: true };
    },

    async disarm() {
      if (!pubRef) return { ok: false };
      await update(pubRef, {
        status: "IDLE",
        since: Date.now(),
        startAt: null,
        durationMs: 0,
        armedAt: null,
      });
      await appendLog("DISARMED");
      return { ok: true };
    },

    async startCountdown(mins: number, secs: number) {
      if (!pubRef) return { ok: false };
      const dur = (mins * 60 + secs) * 1000;
      await update(pubRef, {
        status: "COUNTDOWN",
        since: Date.now(),
        startAt: Date.now(),
        durationMs: dur,
      });
      await appendLog(`COUNTDOWN START ${mins}m ${pad2(secs)}s`);
      return { ok: true };
    },

    async abort() {
      if (!pubRef) return { ok: false };
      await update(pubRef, { status: "ABORTED", since: Date.now(), startAt: null, durationMs: 0 });
      await appendLog("ABORTED");
      return { ok: true };
    },

    async reset() {
      if (!pubRef) return { ok: false };
      await update(pubRef, { status: "IDLE", since: Date.now(), startAt: null, durationMs: 0 });
      await appendLog("RESET");
      return { ok: true };
    },
  };
}

// =============== UI PRIMITIVES ===============
function Banner({ text }: { text: string }) {
  if (!text) return null;
  return (
    <div className="fixed left-0 right-0 top-14 z-30 border-b-2 border-red-900 bg-red-950 px-4 py-2 text-center text-xs font-extrabold tracking-[0.18em] uppercase text-red-200">
      {text}
    </div>
  );
}

function Toasts({ toasts }: { toasts: string[] }) {
  return (
    <div className="fixed bottom-3 right-3 z-[9999] flex flex-col gap-2">
      {toasts.map((t, i) => (
        <div
          key={i}
          className="rounded-lg border border-red-400/50 bg-red-950/60 px-3 py-2 text-[11px] font-black tracking-wider text-rose-100"
        >
          {t}
        </div>
      ))}
    </div>
  );
}

// =============== MAIN APP ====================
export default function App() {
  const { db, user, connected } = useFirebase();
  const pub = usePublic(db);
  const { sec, isOperator } = useSecurity(db, user?.uid);
  const operatorCapable = useProbe(db, isOperator);
  const actions = useActions(db, user);

  // Anti-flicker: hold INIT banner until stable for 900ms
  const [initSince, setInitSince] = useState<number | null>(null);
  const [banner, setBanner] = useState("");
  useEffect(() => {
    if (connected && user) {
      if (!initSince) setInitSince(Date.now());
      const ok = Date.now() - (initSince ?? Date.now()) >= 900;
      if (ok) {
        if (!operatorCapable) setBanner("ACCESS DENIED â€” NOT OPERATOR Â· Claim or Rekey");
        else setBanner("");
      } else setBanner("INITIALIZINGâ€¦");
    } else {
      setInitSince(null);
      setBanner("INITIALIZINGâ€¦");
    }
  }, [connected, user, operatorCapable, initSince]);

  const [toasts, setToasts] = useState<string[]>([]);
  function toast(msg: string) {
    setToasts((t) => [...t, msg]);
    setTimeout(() => setToasts((t) => t.slice(1)), 4200);
  }

  // Local gate for Control tab
  const [unlocked, setUnlocked] = useState(false);

  // Forms state
  const [pin, setPin] = useState("");
  const [rkToken, setRkToken] = useState("");

  const [o1n, setO1n] = useState("");
  const [o1p, setO1p] = useState("");
  const [o2n, setO2n] = useState("");
  const [o2p, setO2p] = useState("");

  const [v1n, setV1n] = useState("");
  const [v1p, setV1p] = useState("");
  const [v2n, setV2n] = useState("");
  const [v2p, setV2p] = useState("");

  // Actions wiring
  async function handleUnlock(e: React.FormEvent) {
    e.preventDefault();
    if (!sec.pinHash) return toast("No PIN set yet");
    const h = await sha256(pin);
    if (h === sec.pinHash) {
      setUnlocked(true);
      toast("Control unlocked");
    } else toast("Bad PIN");
  }

  async function handleSetPin() {
    if (!operatorCapable) return toast("Only operator can set PIN");
    if (pin.length < 4) return toast("PIN too short");
    await actions.setPin(pin);
    toast("PIN set");
  }

  async function handleGenToken() {
    if (!operatorCapable) return toast("Only operator can generate token");
    const r = await actions.genToken();
    if (r.ok && r.token) {
      setRkToken(r.token);
      toast("Recovery token generated (copy it)");
    }
  }

  async function handleRekey(e: React.FormEvent) {
    e.preventDefault();
    const r = await actions.rekeyWithToken(rkToken);
    if (r.ok) {
      setUnlocked(true);
      toast("Operator transferred to this device");
    } else toast(r.msg || "Invalid token");
  }

  async function handleSaveOfficers(e: React.FormEvent) {
    e.preventDefault();
    if (!operatorCapable) return toast("Operator required");
    const o1 = { name: o1n.trim(), pinHash: o1p ? await sha256(o1p) : null };
    const o2 = { name: o2n.trim(), pinHash: o2p ? await sha256(o2p) : null };
    await actions.saveOfficers(o1, o2);
    toast("Officers saved");
  }

  async function handleArm(e: React.FormEvent) {
    e.preventDefault();
    if (!operatorCapable) return toast("Operator required");
    const r = await actions.arm(v1n.trim(), v1p, v2n.trim(), v2p);
    if (!r.ok) return toast(r.msg || "Failed to arm");
    toast("Armed");
  }

  // Countdown controls
  const [mins, setMins] = useState(10);
  const [secs, setSecs] = useState(0);

  // Tick time text
  const [nowTs, setNowTs] = useState(Date.now());
  useEffect(() => {
    const t = setInterval(() => setNowTs(Date.now()), 250);
    return () => clearInterval(t);
  }, []);

  const left = (pub.startAt ?? 0) + (pub.durationMs ?? 0) - nowTs;

  return (
    <div className="min-h-screen bg-[#070709] text-[#eef3ff]">
      <header className="sticky top-0 z-20 border-b-2 border-[#262a34] bg-gradient-to-b from-[#0e1118] to-[#0a0c11] px-4 py-2">
        <div className="flex items-center gap-3">
          <div className="h-6 w-40 rounded-l-[12px] bg-[#ffb400]" />
          <div className="h-6 w-28 rounded-r-[12px] bg-[#ff3b3b]" />
          <div className="text-sm font-black uppercase tracking-[.28em]">
            LCARS // SELF-DESTRUCT CONSOLE
          </div>
          <div className="ml-auto flex gap-2">
            {/* tabs handled inline below */}
          </div>
        </div>
      </header>

      <Banner text={banner} />
      <Toasts toasts={toasts} />

      <main className="mx-auto max-w-[1200px] px-4 py-6">
        {/* TABS */}
        <div className="mb-4 flex gap-2">
          <button
            className={`rounded-full border-2 border-[#262a34] bg-[#131722] px-4 py-2 text-xs font-extrabold tracking-wider ${
              true ? "" : ""
            }`}
            onClick={() => {
              // scroll to countdown
              document.getElementById("viewCountdown")?.scrollIntoView({ behavior: "smooth" });
            }}
          >
            COUNTDOWN
          </button>
          <button
            className="rounded-full border-2 border-[#262a34] bg-[#131722] px-4 py-2 text-xs font-extrabold tracking-wider"
            onClick={() => {
              document.getElementById("viewControl")?.scrollIntoView({ behavior: "smooth" });
            }}
          >
            CONTROL
          </button>
          <div className="ml-auto flex items-center gap-3 text-[11px] text-[#9fb0c9]">
            <span className="uppercase tracking-wider">UID</span>
            <code className="text-xs">{user?.uid ?? "â€”"}</code>
            <span
              className={`rounded-full border px-2 py-1 text-[10px] font-black tracking-wider ${
                isOperator ? "border-emerald-700 bg-emerald-950 text-emerald-300" : "border-zinc-600 bg-zinc-900 text-zinc-300"
              }`}
            >
              {isOperator ? "OPERATOR DEVICE" : "VIEWER DEVICE"}
            </span>
          </div>
        </div>

        {/* COUNTDOWN VIEW */}
        <section id="viewCountdown" className="grid grid-cols-1 gap-4">
          <div className="flex flex-col items-center rounded-2xl border border-[#202c3d] bg-gradient-to-b from-[#161b28] to-[#111621] p-6 text-center shadow-[0_10px_30px_rgba(0,0,0,.35)]">
            <h2 className="mb-2 text-base uppercase tracking-widest">SELF-DESTRUCT STATUS</h2>
            <div className="flex flex-wrap items-center justify-center gap-3">
              <span className="text-[13px] uppercase tracking-widest text-[#9fb0c9]">STATE</span>
              <span
                className={`rounded-full px-3 py-1 text-xs font-black tracking-widest ${
                  pub.status === "IDLE"
                    ? "border border-emerald-900 bg-emerald-950 text-emerald-300"
                    : pub.status === "ARMED"
                    ? "border border-amber-800 bg-amber-950 text-amber-300"
                    : pub.status === "COUNTDOWN"
                    ? "border border-red-900 bg-red-950 text-red-300"
                    : pub.status === "ABORTED"
                    ? "border border-zinc-600 bg-zinc-900 text-zinc-200"
                    : "border border-rose-900 bg-rose-950 text-rose-300"
                }`}
              >
                {pub.status}
              </span>
              <span className="text-[13px] uppercase tracking-widest text-[#9fb0c9]">SINCE</span>
              <span>{pub.since ? new Date(pub.since).toLocaleString() : "â€“"}</span>
            </div>

            <div className="mt-3 flex flex-col items-center gap-2">
              <div className="text-[13px] uppercase tracking-widest text-[#9fb0c9]">TIME REMAINING</div>
              <div className={`text-[72px] leading-none tabular-nums ${left <= 30_000 ? "animate-pulse" : ""}`}>
                {pub.status === "COUNTDOWN" ? fmt(left) : pub.status === "ARMED" ? "â€” â€” : â€” â€”" : "00:00"}
              </div>
              <div className="mt-2 h-[18px] w-[min(900px,92vw)] overflow-hidden rounded-full border border-[#1f2d44] bg-[#101827]">
                <div
                  className="h-full transition-[width]"
                  style={{
                    width:
                      pub.status === "COUNTDOWN" && pub.durationMs > 0
                        ? `${Math.max(0, Math.min(100, Math.round(100 * (1 - left / pub.durationMs))))}%`
                        : "0%",
                    background:
                      "linear-gradient(90deg, #2be4a1, #ffb400, #ff4b4b)",
                  }}
                />
              </div>
              <div className="text-sm text-[#9fb0c9]">
                {pub.status === "COUNTDOWN"
                  ? `${Math.floor((pub.durationMs || 0) / 60000)}m ${pad2(
                      Math.floor(((pub.durationMs || 0) / 1000) % 60)
                    )}s from ${new Date(pub.startAt || 0).toLocaleTimeString()}`
                  : pub.status === "ARMED"
                  ? "Awaiting MARK"
                  : "â€”"}
              </div>
            </div>
          </div>

          <div className="mx-auto w-full max-w-[980px] rounded-2xl border border-[#202c3d] bg-gradient-to-b from-[#161b28] to-[#111621] p-4">
            <h2 className="mb-2 text-base uppercase tracking-widest">EVENT LOG</h2>
            <pre className="h-[220px] overflow-auto rounded-xl border border-[#1b2740] bg-[#0b0f18] p-3 font-mono text-xs leading-5 text-blue-100">
{(pub.logPublic || []).slice().reverse().join("\n")}
            </pre>
          </div>
        </section>

        {/* CONTROL VIEW */}
        <section id="viewControl" className="mt-6 grid grid-cols-1 gap-4 md:grid-cols-2">
          {/* Operator Card */}
          <div className="rounded-2xl border border-[#202c3d] bg-gradient-to-b from-[#161b28] to-[#111621] p-4">
            <h2 className="mb-3 text-base uppercase tracking-widest">OPERATOR DEVICE</h2>
            <div className="flex flex-wrap items-center gap-3 text-sm">
              <div>
                <span className="text-[11px] uppercase tracking-widest text-[#9fb0c9]">UID</span>{" "}
                <code className="text-xs">{user?.uid ?? "â€”"}</code>
              </div>
              <button
                className="rounded-lg border border-sky-700 bg-sky-900/30 px-3 py-2 text-[11px] font-black tracking-wider"
                onClick={() => {
                  if (!navigator.clipboard || !user?.uid) return;
                  navigator.clipboard.writeText(user.uid);
                  toast("UID copied");
                }}
              >
                Copy UID
              </button>
              <button
                className="rounded-lg border border-emerald-700 bg-emerald-900/30 px-3 py-2 text-[11px] font-black tracking-wider"
                onClick={async () => {
                  const r = await actions.claimOperator();
                  toast(r.msg || (r.ok ? "Operator claimed" : "Failed"));
                }}
              >
                Set this device as operator
              </button>
              <button
                className="rounded-lg border border-rose-700 bg-rose-900/30 px-3 py-2 text-[11px] font-black tracking-wider"
                onClick={async () => {
                  if (!operatorCapable) return toast("Only operator can reset");
                  await actions.resetOperator();
                  toast("Operator cleared");
                }}
              >
                Reset operator (null)
              </button>
            </div>
            <p className="mt-2 text-[11px] text-[#9fb0c9]">
              If no operator is set, any signed-in device can claim. Once set,
              only that operator (or a recovery token) can transfer.
            </p>
          </div>

          {/* Access Control (PIN + Rekey) */}
          <div className="rounded-2xl border border-[#202c3d] bg-gradient-to-b from-[#161b28] to-[#111621] p-4">
            <h2 className="mb-3 text-base uppercase tracking-widest">ACCESS CONTROL</h2>
            <form
              onSubmit={handleUnlock}
              className="grid grid-cols-1 gap-2 sm:grid-cols-[1fr_auto]"
              autoComplete="on"
              noValidate
            >
              <div>
                <label className="mb-1 block text-[11px] uppercase tracking-widest text-[#9fb0c9]">
                  Operator PIN
                </label>
                <input
                  className="w-full rounded-xl border border-[#203049] bg-[#0f1421] px-3 py-2 text-sm"
                  type="password"
                  name="operator_pin"
                  inputMode="numeric"
                  autoComplete="current-password"
                  value={pin}
                  onChange={(e) => setPin(e.target.value)}
                  placeholder="Enter PIN"
                />
              </div>
              <div className="flex items-end gap-2">
                <button type="submit" className="rounded-xl border border-emerald-600 px-3 py-2 text-[11px] font-black tracking-wider">
                  Unlock
                </button>
                <button
                  type="button"
                  className="rounded-xl border border-sky-600 px-3 py-2 text-[11px] font-black tracking-wider"
                  onClick={handleSetPin}
                >
                  Set PIN
                </button>
              </div>
            </form>

            <form
              onSubmit={handleRekey}
              className="mt-3 grid grid-cols-1 gap-2 sm:grid-cols-[1fr_auto]"
              autoComplete="off"
              noValidate
            >
              <div>
                <label className="mb-1 block text-[11px] uppercase tracking-widest text-[#9fb0c9]">
                  Recovery Token
                </label>
                <input
                  className="w-full rounded-xl border border-[#203049] bg-[#0f1421] px-3 py-2 text-sm"
                  type="password"
                  name="recovery_token"
                  autoComplete="one-time-code"
                  value={rkToken}
                  onChange={(e) => setRkToken(e.target.value)}
                  placeholder="Paste token"
                />
              </div>
              <div className="flex items-end gap-2">
                <button type="submit" className="rounded-xl border border-amber-600 px-3 py-2 text-[11px] font-black tracking-wider">
                  Rekey via Token
                </button>
                <button
                  type="button"
                  className="rounded-xl border border-amber-600/60 px-3 py-2 text-[11px] font-black tracking-wider"
                  onClick={handleGenToken}
                >
                  Generate Token
                </button>
              </div>
            </form>
            {!unlocked && (
              <p className="mt-2 text-[11px] text-[#9fb0c9]">
                Unlocking is local UI only; server authority still enforced by
                rules (operator required for writes).
              </p>
            )}
          </div>

          {/* Officers */}
          <div className="rounded-2xl border border-[#202c3d] bg-gradient-to-b from-[#161b28] to-[#111621] p-4">
            <h2 className="mb-3 text-base uppercase tracking-widest">OFFICERS â€” ONEâ€‘TIME SETUP</h2>
            <form onSubmit={handleSaveOfficers} className="grid grid-cols-1 gap-3 sm:grid-cols-2" noValidate>
              <div>
                <label className="mb-1 block text-[11px] uppercase tracking-widest text-[#9fb0c9]">
                  Officer 1 Name
                </label>
                <input
                  className="w-full rounded-xl border border-[#203049] bg-[#0f1421] px-3 py-2 text-sm"
                  value={o1n}
                  onChange={(e) => setO1n(e.target.value)}
                  placeholder="Name"
                />
              </div>
              <div>
                <label className="mb-1 block text-[11px] uppercase tracking-widest text-[#9fb0c9]">
                  Officer 1 PIN
                </label>
                <input
                  className="w-full rounded-xl border border-[#203049] bg-[#0f1421] px-3 py-2 text-sm"
                  type="password"
                  autoComplete="new-password"
                  value={o1p}
                  onChange={(e) => setO1p(e.target.value)}
                  placeholder="â€¢â€¢â€¢â€¢"
                />
              </div>
              <div>
                <label className="mb-1 block text-[11px] uppercase tracking-widest text-[#9fb0c9]">
                  Officer 2 Name
                </label>
                <input
                  className="w-full rounded-xl border border-[#203049] bg-[#0f1421] px-3 py-2 text-sm"
                  value={o2n}
                  onChange={(e) => setO2n(e.target.value)}
                  placeholder="Name"
                />
              </div>
              <div>
                <label className="mb-1 block text-[11px] uppercase tracking-widest text-[#9fb0c9]">
                  Officer 2 PIN
                </label>
                <input
                  className="w-full rounded-xl border border-[#203049] bg-[#0f1421] px-3 py-2 text-sm"
                  type="password"
                  autoComplete="new-password"
                  value={o2p}
                  onChange={(e) => setO2p(e.target.value)}
                  placeholder="â€¢â€¢â€¢â€¢"
                />
              </div>
              <div className="sm:col-span-2">
                <button type="submit" className="rounded-xl border border-amber-600 px-3 py-2 text-[11px] font-black tracking-wider">
                  Save Officers
                </button>
              </div>
            </form>
          </div>

          {/* Arming + Countdown */}
          <div className="rounded-2xl border border-[#202c3d] bg-gradient-to-b from-[#161b28] to-[#111621] p-4">
            <h2 className="mb-3 text-base uppercase tracking-widest">ARMING â€” VERIFY</h2>
            <form onSubmit={handleArm} className="grid grid-cols-1 gap-3 sm:grid-cols-2" noValidate>
              <div>
                <label className="mb-1 block text-[11px] uppercase tracking-widest text-[#9fb0c9]">
                  Officer 1 Name
                </label>
                <input
                  className="w-full rounded-xl border border-[#203049] bg-[#0f1421] px-3 py-2 text-sm"
                  value={v1n}
                  onChange={(e) => setV1n(e.target.value)}
                  placeholder="Enter O1 name"
                />
              </div>
              <div>
                <label className="mb-1 block text-[11px] uppercase tracking-widest text-[#9fb0c9]">
                  Officer 1 PIN
                </label>
                <input
                  className="w-full rounded-xl border border-[#203049] bg-[#0f1421] px-3 py-2 text-sm"
                  type="password"
                  autoComplete="current-password"
                  value={v1p}
                  onChange={(e) => setV1p(e.target.value)}
                  placeholder="â€¢â€¢â€¢â€¢"
                />
              </div>
              <div>
                <label className="mb-1 block text-[11px] uppercase tracking-widest text-[#9fb0c9]">
                  Officer 2 Name
                </label>
                <input
                  className="w-full rounded-xl border border-[#203049] bg-[#0f1421] px-3 py-2 text-sm"
                  value={v2n}
                  onChange={(e) => setV2n(e.target.value)}
                  placeholder="Enter O2 name"
                />
              </div>
              <div>
                <label className="mb-1 block text-[11px] uppercase tracking-widest text-[#9fb0c9]">
                  Officer 2 PIN
                </label>
                <input
                  className="w-full rounded-xl border border-[#203049] bg-[#0f1421] px-3 py-2 text-sm"
                  type="password"
                  autoComplete="current-password"
                  value={v2p}
                  onChange={(e) => setV2p(e.target.value)}
                  placeholder="â€¢â€¢â€¢â€¢"
                />
              </div>
              <div className="sm:col-span-2 flex gap-2">
                <button type="submit" className="rounded-xl border border-amber-600 px-3 py-2 text-[11px] font-black tracking-wider">
                  Arm
                </button>
                <button
                  type="button"
                  className="rounded-xl border border-zinc-600 px-3 py-2 text-[11px] font-black tracking-wider"
                  onClick={async () => {
                    const r = await actions.disarm();
                    if (r.ok) toast("Disarmed");
                  }}
                >
                  Disarm
                </button>
              </div>
            </form>
          </div>

          <div className="rounded-2xl border border-[#202c3d] bg-gradient-to-b from-[#161b28] to-[#111621] p-4">
            <h2 className="mb-3 text-base uppercase tracking-widest">COUNTDOWN</h2>
            <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
              <div>
                <label className="mb-1 block text-[11px] uppercase tracking-widest text-[#9fb0c9]">Minutes</label>
                <input
                  className="w-full rounded-xl border border-[#203049] bg-[#0f1421] px-3 py-2 text-sm"
                  type="number"
                  min={0}
                  value={mins}
                  onChange={(e) => setMins(parseInt(e.target.value || "0"))}
                />
              </div>
              <div>
                <label className="mb-1 block text-[11px] uppercase tracking-widest text-[#9fb0c9]">Seconds</label>
                <input
                  className="w-full rounded-xl border border-[#203049] bg-[#0f1421] px-3 py-2 text-sm"
                  type="number"
                  min={0}
                  max={59}
                  value={secs}
                  onChange={(e) => setSecs(parseInt(e.target.value || "0"))}
                />
              </div>
              <div className="sm:col-span-2 flex gap-2">
                <button
                  className="rounded-xl border border-emerald-600 px-3 py-2 text-[11px] font-black tracking-wider"
                  onClick={async () => {
                    const r = await actions.startCountdown(mins, secs);
                    if (r.ok) toast("Countdown started");
                  }}
                >
                  Start (MARK)
                </button>
                <button
                  className="rounded-xl border border-rose-600 px-3 py-2 text-[11px] font-black tracking-wider"
                  onClick={async () => {
                    const r = await actions.abort();
                    if (r.ok) toast("Aborted");
                  }}
                >
                  Abort
                </button>
                <button
                  className="rounded-xl border border-zinc-600 px-3 py-2 text-[11px] font-black tracking-wider"
                  onClick={async () => {
                    const r = await actions.reset();
                    if (r.ok) toast("Reset");
                  }}
                >
                  Reset
                </button>
              </div>
            </div>
          </div>
        </section>
      </main>
