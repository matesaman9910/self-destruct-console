<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LCARS Self‑Destruct — v8.2</title>
<style>
:root{--bg:#070709;--text:#eef3ff;--muted:#9fb0c9;--line:#262a34;--ok:#2be4a1;--warn:#ffb400;--alert:#ff4b4b;--amber:#ffb400;--red:#ff3b3b}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
header{position:sticky;top:0;z-index:20;padding:10px 14px;background:linear-gradient(180deg,#0e1118,#0a0c11);border-bottom:2px solid var(--line)}
.lcars{display:flex;align-items:center;gap:14px}
.lcars .b1{height:24px;width:160px;border-radius:12px 0 0 12px;background:var(--amber)}
.lcars .b2{height:24px;width:110px;border-radius:0 12px 12px 0;background:var(--red)}
.title{letter-spacing:.28em;text-transform:uppercase;font-weight:900}
.tabs{margin-left:auto;display:flex;gap:8px}
.tab{cursor:pointer;padding:10px 14px;border:2px solid var(--line);background:#131722;border-radius:999px;color:#dde7ff;font-weight:800;letter-spacing:.08em}
.tab.active{background:linear-gradient(90deg,#2a0000,#4a0000);border-color:#a22;color:#fff}
main{max-width:1200px;margin:0 auto;padding:22px}
#banner{position:fixed;left:0;right:0;top:50px;z-index:25;padding:10px 16px;text-align:center;font-weight:900;letter-spacing:.18em;text-transform:uppercase;border-bottom:2px solid #300;background:#1a0000;color:#ff9b9b;display:none}
#toasts{position:fixed;right:12px;bottom:12px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{background:#220;border:1px solid #933;color:#fbb;padding:8px 10px;border-radius:10px;font-weight:800;letter-spacing:.1em;text-transform:uppercase}
.grid{display:grid;gap:18px}
.card{background:linear-gradient(180deg,#161b28,#111621);border:1px solid #202c3d;border-radius:18px;padding:18px}
.card h2{margin:0 0 12px;letter-spacing:.12em;text-transform:uppercase}
.two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
input{background:#0f1421;border:1px solid #203049;color:#eaf2ff;padding:12px;border-radius:12px;width:100%}
label{display:block;font-size:12px;color:#9fb0c9;margin-bottom:6px}
button{cursor:pointer;padding:12px 14px;border-radius:12px;border:1px solid #2a3b56;background:#0f1623;color:#e6eefb;font-weight:800}
button.primary{border-color:#21d39e}
button.warn{border-color:#ffb400}
button.danger{border-color:#ff3b3b}
.small{font-size:12px;color:#9fb0c9}
.code{font-family:ui-monospace,Menlo,Consolas,monospace}
.statusRow{display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap}
.pill{padding:6px 14px;border-radius:999px;font-weight:900;letter-spacing:.1em}
.pill.idle{background:#0b241a;color:var(--ok);border:1px solid #1b5c44}
.pill.armed{background:#241f0b;color:var(--warn);border:1px solid #6b560d}
.pill.countdown{background:#2a0b0b;color:var(--alert);border:1px solid #6b2323}
.pill.aborted{background:#1e1e1e;color:#cfcfcf;border:1px solid #3a3a3a}
.pill.detonated{background:#360909;color:#ff9b9b;border:1px solid #833}
.timer{display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:14px}
.big{font-variant-numeric:tabular-nums;font-size:96px;line-height:1}
.bar{height:18px;background:#101827;border:1px solid #1f2d44;border-radius:999px;overflow:hidden;width:min(900px,92vw);margin-top:12px}
.bar>div{height:100%;width:0%;background:linear-gradient(90deg,var(--ok),var(--warn),var(--alert));transition:width .2s linear}
.log{background:#0b0f18;border:1px solid #1b2740;border-radius:14px;padding:12px;height:220px;overflow:auto}
.flash{animation:flash .8s steps(4) infinite}
@keyframes flash{50%{opacity:.35}}
</style>
</head>
<body>
<header>
  <div class="lcars">
    <div class="b1"></div><div class="b2"></div>
    <div class="title">LCARS // SELF‑DESTRUCT</div>
    <div class="tabs">
      <button class="tab active" id="tabCountdown">COUNTDOWN</button>
      <button class="tab" id="tabControl">CONTROL</button>
    </div>
  </div>
</header>
<div id="banner">INITIALIZING…</div>
<div id="toasts"></div>

<main class="grid">
  <section id="viewCountdown" class="grid">
    <div class="card" style="display:flex;flex-direction:column;align-items:center;text-align:center">
      <h2>SELF‑DESTRUCT STATUS</h2>
      <div class="statusRow">
        <span class="small">STATE</span><span id="statusPill" class="pill idle">IDLE</span>
        <span class="small">SINCE</span><span id="since">–</span>
      </div>
      <div class="timer">
        <div class="small">TIME REMAINING</div>
        <div id="timeLeft" class="big">00:00</div>
        <div class="bar"><div id="barFill"></div></div>
        <div class="small" id="countdownInfo">—</div>
      </div>
    </div>
    <div class="card" style="max-width:min(980px,92vw);margin:0 auto">
      <h2>EVENT LOG</h2>
      <pre id="log" class="log code"></pre>
    </div>
  </section>

  <section id="viewControl" class="grid" style="display:none;grid-template-columns:1fr 1fr">
    <div class="card">
      <h2>OPERATOR</h2>
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <div><span class="small">UID</span> <code id="uidVal">—</code></div>
        <div class="pill" id="opStatus" style="padding:4px 10px">VIEWER DEVICE</div>
        <button id="btnCopyUid">Copy UID</button>
        <button id="btnClaim">Set this device as operator</button>
        <button id="btnResetOp" class="danger">Reset operator (null)</button>
      </div>
      <p class="small">If operator not set, any signed‑in device can claim. Once set, only that operator (or a valid recovery token) can transfer.</p>
    </div>

    <div class="card">
      <h2>ACCESS CONTROL</h2>
      <form id="formPin" class="two" autocomplete="on" novalidate>
        <div>
          <label for="pin">Operator PIN</label>
          <input id="pin" name="operator_pin" type="password" placeholder="Enter PIN" autocomplete="current-password" inputmode="numeric"/>
        </div>
        <div style="display:flex;gap:8px;align-items:end">
          <button id="btnUnlock" class="primary" type="submit">Unlock</button>
          <button id="btnSetPin" type="button">Set PIN</button>
        </div>
      </form>

      <form id="formRekey" class="two" autocomplete="off" novalidate style="margin-top:8px">
        <div>
          <label for="rkToken">Recovery Token</label>
          <input id="rkToken" name="recovery_token" type="password" placeholder="Paste token" autocomplete="one-time-code"/>
        </div>
        <div style="display:flex;gap:8px;align-items:end">
          <button id="btnRekey" class="warn" type="submit">Rekey via Token</button>
          <button id="btnGenToken" type="button">Generate Token (operator)</button>
        </div>
      </form>
      <p class="small">Rekey is server-verified via hash; token never stored in DB. Token is single‑use.</p>
    </div>

    <div class="card">
      <h2>OFFICERS — ONE‑TIME SETUP</h2>
      <form id="formOfficers" class="two" autocomplete="off" novalidate>
        <div><label for="o1n">Officer 1 Name</label><input id="o1n" placeholder="Name"/></div>
        <div><label for="o1p">Officer 1 PIN</label><input id="o1p" type="password" placeholder="••••" autocomplete="new-password"/></div>
        <div><label for="o2n">Officer 2 Name</label><input id="o2n" placeholder="Name"/></div>
        <div><label for="o2p">Officer 2 PIN</label><input id="o2p" type="password" placeholder="••••" autocomplete="new-password"/></div>
        <div style="grid-column:1/-1;display:flex;gap:8px;margin-top:10px">
          <button id="btnSaveOfficers" class="warn" type="submit">Save Officers</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h2>ARMING — VERIFY</h2>
      <form id="formVerify" class="two" autocomplete="off" novalidate>
        <div><label for="v1n">Officer 1 Name</label><input id="v1n" placeholder="Enter O1 name"/></div>
        <div><label for="v1p">Officer 1 PIN</label><input id="v1p" type="password" placeholder="••••" autocomplete="current-password"/></div>
        <div><label for="v2n">Officer 2 Name</label><input id="v2n" placeholder="Enter O2 name"/></div>
        <div><label for="v2p">Officer 2 PIN</label><input id="v2p" type="password" placeholder="••••" autocomplete="current-password"/></div>
        <div style="grid-column:1/-1;display:flex;gap:8px;margin-top:10px">
          <button id="btnArm" class="warn" type="submit">Arm</button>
          <button id="btnDisarm" type="button">Disarm</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h2>COUNTDOWN</h2>
      <div class="two">
        <div><label for="mins">Minutes</label><input id="mins" type="number" min="0" value="10"/></div>
        <div><label for="secs">Seconds</label><input id="secs" type="number" min="0" max="59" value="0"/></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
        <button id="btnStart" class="primary">Start (MARK)</button>
        <button id="btnAbort" class="danger">Abort</button>
        <button id="btnReset">Reset</button>
      </div>
    </div>
  </section>
</main>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
import { getDatabase, ref, child, onValue, update, get } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';

/* CONFIG */
const firebaseConfig={ apiKey:"AIzaSyCbXxL7mv9U10MxYkdNsVQrijrpsVGoGU0", authDomain:"self-destruct-console.firebaseapp.com", databaseURL:"https://self-destruct-console-default-rtdb.europe-west1.firebasedatabase.app/", projectId:"self-destruct-console", storageBucket:"self-destruct-console.firebasestorage.app", messagingSenderId:"669939099742", appId:"1:669939099742:web:310269ae940dd68a84accf" };

/* UTIL */
const $=s=>document.querySelector(s); const now=()=>Date.now(); const pad2=n=>String(n).padStart(2,'0');
const fmt=ms=>{ if(ms<0) ms=0; const t=Math.floor(ms/1000),h=Math.floor(t/3600),m=Math.floor((t%3600)/60),s=t%60; return (h?pad2(h)+':':'')+pad2(m)+':'+pad2(s); };
function toast(txt){ const d=document.createElement('div'); d.className='toast'; d.textContent=txt; $('#toasts').appendChild(d); setTimeout(()=>d.remove(),4200); }
async function sha256(str){ const buf=new TextEncoder().encode(str); const h=await crypto.subtle.digest('SHA-256',buf); return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join(''); }

/* STATE */
let app, db, auth; let connected=false, authed=false, operatorCapable=false;
let initStableSince=0; const STABLE_MS=900; // anti‑flicker
let publicState={status:'IDLE',since:0,startAt:null,durationMs:0,armedAt:null,logPublic:[]};
let SEC={ operatorUid:null, pinHash:null, recoveryHash:null, rekeyAttempt:null, officers:{ o1:{}, o2:{} } };

/* DOM refs */
const banner=$('#banner'); const statusPill=$('#statusPill'), sinceEl=$('#since'), timeLeftEl=$('#timeLeft'), barFill=$('#barFill'), infoEl=$('#countdownInfo'), logEl=$('#log');

/* NAV */
$('#tabCountdown').addEventListener('click',()=>showTab('countdown'));
$('#tabControl').addEventListener('click',()=>showTab('control'));
function showTab(which){ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); if(which==='control'){ $('#tabControl').classList.add('active'); $('#viewControl').style.display='grid'; $('#viewCountdown').style.display='none'; } else { $('#tabCountdown').classList.add('active'); $('#viewControl').style.display='none'; $('#viewCountdown').style.display='grid'; } }

function setBanner(txt){ banner.textContent=txt; banner.style.display = txt? 'block':'none'; }
function recomputeBanner(){ if(!(connected && authed)){ setBanner('INITIALIZING…'); return; } if(initStableSince===0) initStableSince=now(); if(now()-initStableSince<STABLE_MS){ setBanner('INITIALIZING…'); return; } setBanner(operatorCapable? '' : 'ACCESS DENIED — NOT OPERATOR · Claim or Rekey'); }

function render(){ const s=publicState.status||'IDLE'; statusPill.textContent=s; statusPill.className='pill '+s.toLowerCase(); sinceEl.textContent = publicState.since ? new Date(publicState.since).toLocaleString() : '–'; if(s==='COUNTDOWN'){ const left=(publicState.startAt||0)+(publicState.durationMs||0)-now(); timeLeftEl.textContent=fmt(left); timeLeftEl.classList.toggle('flash', left<=30000); if(publicState.durationMs>0) barFill.style.width=Math.max(0,Math.min(100,Math.round(100*(1-left/publicState.durationMs))))+'%'; infoEl.textContent=`${Math.floor((publicState.durationMs||0)/60000)}m ${pad2(Math.floor((publicState.durationMs||0)/1000)%60)}s from ${new Date(publicState.startAt||0).toLocaleTimeString()}`; } else if(s==='ARMED'){ timeLeftEl.textContent='— — : — —'; timeLeftEl.classList.remove('flash'); barFill.style.width='0%'; infoEl.textContent='Awaiting MARK'; } else if(s==='DETONATED'){ timeLeftEl.textContent='00:00'; barFill.style.width='100%'; } else { timeLeftEl.textContent='00:00'; barFill.style.width='0%'; infoEl.textContent='—'; } logEl.textContent=(publicState.logPublic||[]).slice().reverse().join('\n'); }

/* BOOT */
let root, pubRef, secRef, probeRef;
(async function init(){ try{ app = initializeApp(firebaseConfig); auth = getAuth(app); await signInAnonymously(auth); onAuthStateChanged(auth, u=>{ authed=!!u; $('#uidVal').textContent=u?u.uid:'—'; if(u) initStableSince=now(); recomputeBanner(); render(); }); db = getDatabase(app); root=ref(db,'selfDestruct'); pubRef=child(root,'public'); secRef=child(root,'security'); probeRef=child(root,'updateProbe'); onValue(ref(db,'.info/connected'), s=>{ connected=(s.val()===true); if(connected) initStableSince=now(); recomputeBanner(); render(); }); const pub=(k,cb)=> onValue(child(pubRef,k), snap=>{ cb(snap.val()); render(); }); pub('status',v=> publicState.status=v||'IDLE'); pub('since',v=> publicState.since=v||0); pub('startAt',v=> publicState.startAt=v||null); pub('durationMs',v=> publicState.durationMs=v||0); pub('armedAt',v=> publicState.armedAt=v||null); pub('logPublic',v=> publicState.logPublic=Array.isArray(v)?v:[]);
  // security (readable only to operator); attach cancel to avoid console errors
  onValue(secRef, snap=>{ const v=snap.val()||{}; SEC={...SEC, ...v}; operatorLabel(); }, err=>{ /* ignore permission_denied for non-operator */ });
  setInterval(canaryWrite, 5000); canaryWrite(); }catch(err){ console.error(err); toast('Init error'); } })();

async function canaryWrite(){ try{ await update(probeRef,{t:Date.now()}); operatorCapable=true; } catch{ operatorCapable=false; } finally{ recomputeBanner(); } }
function operatorLabel(){ const el=$('#opStatus'); const me=auth?.currentUser?.uid; const isOp=!!me && SEC.operatorUid===me; el.textContent=isOp?'OPERATOR DEVICE':'VIEWER DEVICE'; el.style.background=isOp?'#0b241a':'#1e1e1e'; el.style.color=isOp?'var(--ok)':'#cfcfcf'; el.style.border=isOp?'1px solid #1b5c44':'1px solid #3a3a3a'; }

/* OPERATOR MGMT */
$('#btnCopyUid').addEventListener('click',()=>{ const uid=auth?.currentUser?.uid; if(uid) navigator.clipboard.writeText(uid).then(()=>toast('UID copied')); });
$('#btnClaim').addEventListener('click', async ()=>{ const uid=auth?.currentUser?.uid; if(!uid){ toast('No auth'); return; } try{ await update(secRef,{operatorUid:uid, operatorSince: Date.now()}); toast('Operator claimed'); await canaryWrite(); } catch(e){ const code=e?.code||''; if(String(code).includes('permission_denied')) toast('Operator already set — use Recovery Token'); else toast('Claim failed'); } });
$('#btnResetOp').addEventListener('click', async ()=>{ if(!operatorCapable){ toast('Only operator'); return; } try{ await update(secRef,{operatorUid:null}); toast('Operator cleared'); operatorCapable=false; recomputeBanner(); } catch{ toast('Reset failed'); } });

/* ACCESS CONTROL */
$('#formPin').addEventListener('submit', async e=>{ e.preventDefault(); const pin=$('#pin').value.trim(); if(!pin){ toast('PIN required'); return; } if(!SEC.pinHash){ toast('No PIN set'); return; } try{ if(await sha256(pin)===SEC.pinHash){ toast('Control unlocked'); } else toast('Bad PIN'); } catch{ toast('Unlock failed'); } });
$('#btnSetPin').addEventListener('click', async ()=>{ if(!operatorCapable){ toast('Only operator'); return; } const pin=$('#pin').value.trim(); if(pin.length<4){ toast('PIN too short'); return; } try{ await update(secRef,{pinHash: await sha256(pin)}); toast('PIN set'); } catch{ toast('Set PIN failed'); } });

// Secure server-verified rekey: write rekeyAttempt = SHA256(token) alongside operatorUid=self and recoveryHash=null
$('#btnGenToken').addEventListener('click', async ()=>{ if(!operatorCapable){ toast('Only operator'); return; } try{ const bytes=new Uint8Array(24); crypto.getRandomValues(bytes); const token=btoa(String.fromCharCode(...bytes)); $('#rkToken').value=token; await update(secRef,{recoveryHash: await sha256(token)}); toast('Token generated'); } catch{ toast('Token generation failed'); } });
$('#formRekey').addEventListener('submit', async e=>{ e.preventDefault(); const token=$('#rkToken').value.trim(); if(!token){ toast('Token required'); return; } const uid=auth?.currentUser?.uid; if(!uid){ toast('No auth'); return; } try{ const h=await sha256(token); await update(secRef,{ operatorUid:uid, operatorSince: Date.now(), recoveryHash:null, rekeyAttempt:h }); toast('Operator transferred to this device'); await canaryWrite(); } catch(err){ const code=err?.code||''; if(String(code).includes('permission_denied')) toast('Rekey failed — invalid token or already operator'); else toast('Rekey failed'); } });

/* OFFICERS */
$('#formOfficers').addEventListener('submit', async e=>{ e.preventDefault(); if(!operatorCapable){ toast('Operator required'); return; } const n1=$('#o1n').value.trim(), p1=$('#o1p').value.trim(); const n2=$('#o2n').value.trim(), p2=$('#o2p').value.trim(); try{ await update(child(secRef,'officers'),{ o1:{name:n1||'', pinHash:p1?await sha256(p1):null}, o2:{name:n2||'', pinHash:p2?await sha256(p2):null} }); toast('Officers saved'); } catch{ toast('Save officers failed'); } });

/* VERIFY + STATE */
async function verifyOfficers(){ try{ const v=(await get(secRef)).val()||{}; const off=v.officers||{}; const i1n=$('#v1n').value.trim(), i1p=$('#v1p').value.trim(); const i2n=$('#v2n').value.trim(), i2p=$('#v2p').value.trim(); const h1=i1p?await sha256(i1p):''; const h2=i2p?await sha256(i2p):''; const ok1=!!off.o1 && (off.o1.name||'')===i1n && (off.o1.pinHash||'')===h1; const ok2=!!off.o2 && (off.o2.name||'')===i2n && (off.o2.pinHash||'')===h2; return ok1 && ok2; } catch{ return false; } }
$('#formVerify').addEventListener('submit', async e=>{ e.preventDefault(); if(!operatorCapable){ toast('Operator required'); return; } if(!(await verifyOfficers())){ toast('Officer verification failed'); return; } try{ await update(pubRef,{status:'ARMED', since: Date.now(), armedAt: Date.now()}); await appendLog('ARMED'); toast('Armed'); } catch{ toast('Arm failed'); } });
$('#btnDisarm').addEventListener('click', async ()=>{ if(!operatorCapable){ toast('Operator required'); return; } try{ await update(pubRef,{status:'IDLE', since: Date.now(), startAt:null, durationMs:0, armedAt:null}); await appendLog('DISARMED'); } catch{ toast('Disarm failed'); } });

/* COUNTDOWN */
$('#btnStart').addEventListener('click', async ()=>{ if(!operatorCapable){ toast('Operator required'); return; } const mins=parseInt($('#mins').value||'0',10)||0; const secs=parseInt($('#secs').value||'0',10)||0; const dur=(mins*60+secs)*1000; try{ await update(pubRef,{status:'COUNTDOWN', since: Date.now(), startAt: Date.now(), durationMs: dur}); await appendLog(`COUNTDOWN START ${mins}m ${pad2(secs)}s`); } catch{ toast('Start failed'); } });
$('#btnAbort').addEventListener('click', async ()=>{ if(!operatorCapable){ toast('Operator required'); return; } try{ await update(pubRef,{status:'ABORTED', since: Date.now(), startAt:null, durationMs:0}); await appendLog('ABORTED'); } catch{ toast('Abort failed'); } });
$('#btnReset').addEventListener('click', async ()=>{ if(!operatorCapable){ toast('Operator required'); return; } try{ await update(pubRef,{status:'IDLE', since: Date.now(), startAt:null, durationMs:0}); await appendLog('RESET'); } catch{ toast('Reset failed'); } });

async function appendLog(line){ try{ const s=await get(child(pubRef,'logPublic')); let arr=Array.isArray(s.val())?s.val():[]; arr.push(`${new Date().toLocaleString()} — ${line}`); if(arr.length>500) arr=arr.slice(-500); await update(pubRef,{logPublic:arr}); } catch{ /* ignore */ } }

setInterval(()=>{ if(publicState.status==='COUNTDOWN') render(); }, 250);
</script>

<!-- =============================
     REALTIME DATABASE RULES v8.2 (copy into Realtime Database > Rules)
============================== -->
<!--
{
  "rules": {
    ".read": false,
    ".write": false,

    "selfDestruct": {
      "public": {
        ".read": true,
        ".write": "auth != null && ( root.child('selfDestruct/security/operatorUid').val() == auth.uid || !root.child('selfDestruct/security/operatorUid').exists() )",

        "status":     { ".validate": "newData.isString() && newData.val().matches(/^(IDLE|ARMED|COUNTDOWN|ABORTED|DETONATED)$/)" },
        "since":      { ".validate": "newData.isNumber() && newData.val() >= 0" },
        "startAt":    { ".validate": "newData.val() == null || (newData.isNumber() && newData.val() >= 0)" },
        "durationMs": { ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 86400000" },
        "armedAt":    { ".validate": "newData.val() == null || (newData.isNumber() && newData.val() >= 0)" },

        "logPublic": {
          "$i": { ".validate": "$i.matches(/^[0-9]+$/) && newData.isString()" }
        }
      },

      "security": {
        ".read":  "auth != null && root.child('selfDestruct/security/operatorUid').val() == auth.uid",
        ".write": "auth != null && (\n          root.child('selfDestruct/security/operatorUid').val() == auth.uid\n          || !root.child('selfDestruct/security/operatorUid').exists()\n          || (\n            data.child('recoveryHash').exists() &&\n            newData.child('rekeyAttempt').isString() &&\n            newData.child('rekeyAttempt').val().matches(/^[a-f0-9]{64}$/) &&\n            newData.child('rekeyAttempt').val() == data.child('recoveryHash').val() &&\n            newData.child('operatorUid').val() == auth.uid &&\n            newData.child('recoveryHash').val() == null\n          )\n        )",

        "operatorUid": { ".validate": "newData.val() == auth.uid || newData.val() == null" },
        "pinHash":     { ".validate": "newData.val() == null || (newData.isString() && newData.val().matches(/^[a-f0-9]{64}$/))" },
        "recoveryHash":{ ".validate": "newData.val() == null || (newData.isString() && newData.val().matches(/^[a-f0-9]{64}$/))" },
        "rekeyAttempt":{ ".validate": "newData.val() == null || (newData.isString() && newData.val().matches(/^[a-f0-9]{64}$/))" },

        "officers": {
          ".validate": "newData.hasChildren(['o1','o2'])",
          "o1": {"name": { ".validate": "newData.val() == null || newData.isString()" }, "pinHash": { ".validate": "newData.val() == null || (newData.isString() && newData.val().matches(/^[a-f0-9]{64}$/))" }},
          "o2": {"name": { ".validate": "newData.val() == null || newData.isString()" }, "pinHash": { ".validate": "newData.val() == null || (newData.isString() && newData.val().matches(/^[a-f0-9]{64}$/))" }}
        }
      },

      "updateProbe": {
        ".read": true,
        ".write": "auth != null && ( root.child('selfDestruct/security/operatorUid').val() == auth.uid || !root.child('selfDestruct/security/operatorUid').exists() )"
      }
    }
  }
}
-->
</body>
</html>
