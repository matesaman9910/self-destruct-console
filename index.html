<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LCARS Self‑Destruct Console</title>
<style>
  :root{
    --bg:#070709; --text:#f3f6fb; --muted:#a8b3c6;
    --lcars-amber:#ffb400; --lcars-red:#ff3b3b; --line:#20242d;
    --ok:#2be4a1; --warn:#ffb400; --alert:#ff3b3b;
  }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{position:sticky; top:0; z-index:20; padding:10px 14px; background:linear-gradient(180deg,#0f1117,#0a0c10); border-bottom:2px solid var(--line)}
  .lcars{display:flex; align-items:center; gap:14px}
  .lcars .bar{height:24px; width:160px; border-radius:12px 0 0 12px; background:var(--lcars-amber)}
  .lcars .bar2{height:24px; width:110px; border-radius:0 12px 12px 0; background:var(--lcars-red)}
  .title{letter-spacing:.28em; text-transform:uppercase; font-weight:900}
  .tabs{margin-left:auto; display:flex; gap:8px}
  .tab{cursor:pointer; padding:12px 16px; border:2px solid var(--line); background:#131722; border-radius:999px; color:#dde7ff; font-weight:800; letter-spacing:.08em}
  .tab.active{background:linear-gradient(90deg,#2a0000,#460000); color:#fff; border-color:#a22}

  main{max-width:1200px; margin:0 auto; padding:22px}

  /* COUNTDOWN view — big & centered */
  #viewCountdown{display:grid; grid-template-columns:1fr; gap:18px}
  .centerCard{background:linear-gradient(180deg,#161b28,#111621); border:1px solid #202c3d; border-radius:18px; padding:22px; display:flex; flex-direction:column; align-items:center; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .centerCard h2{margin:0 0 12px 0; letter-spacing:.12em; text-transform:uppercase}
  .statusRow{display:flex; gap:12px; align-items:center; justify-content:center; flex-wrap:wrap}
  .pill{padding:6px 14px; border-radius:999px; font-weight:900; letter-spacing:.1em}
  .idle{background:#0b241a; color:var(--ok); border:1px solid #1b5c44}
  .armed{background:#241f0b; color:var(--warn); border:1px solid #6b560d}
  .countdown{background:#2a0b0b; color:var(--alert); border:1px solid #6b2323}
  .aborted{background:#1e1e1e; color:#c0c0c0; border:1px solid #3a3a3a}
  .detonated{background:#380b0b; color:#ff8080; border:1px solid #833}
  .k{color:#9fb0c9; text-transform:uppercase; letter-spacing:.12em; font-size:13px}
  .timer{display:flex; flex-direction:column; align-items:center; gap:10px; margin-top:14px}
  .big{font-variant-numeric:tabular-nums; font-size:96px; line-height:1; letter-spacing:.04em}
  .sub{color:#9fb0c9; font-size:14px}
  .bar{height:18px; background:#101827; border:1px solid #1f2d44; border-radius:999px; overflow:hidden; width:min(900px,92vw); margin-top:12px}
  .bar>div{height:100%; width:0%; background:linear-gradient(90deg,var(--ok),var(--warn),var(--alert)); transition:width .2s linear}
  .log{font-family:ui-monospace,Menlo,Consolas,monospace; background:#0b0f18; border:1px solid #1b2740; border-radius:14px; padding:12px; height:220px; overflow:auto}
  .flash{animation:flash .8s steps(4) infinite}
  @keyframes flash{50%{opacity:.35}}

  /* CONTROL view */
  #viewControl{display:none; grid-template-columns:1fr 1fr; gap:18px}
  .card{background:linear-gradient(180deg,#161b28,#111621); border:1px solid #202c3d; border-radius:18px; padding:18px}
  .card h2{margin:0 0 12px 0; letter-spacing:.12em; text-transform:uppercase}
  .two{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  input{background:#0f1421; border:1px solid #203049; color:#eaf2ff; padding:12px; border-radius:12px; width:100%}
  label{display:block; font-size:12px; color:#9fb0c9; margin-bottom:6px}
  button{cursor:pointer; padding:12px 14px; border-radius:12px; border:1px solid #2a3b56; background:#0f1623; color:#e6eefb; font-weight:800}
  button.primary{border-color:#21d39e}
  button.warn{border-color:#ffb400}
  button.danger{border-color:#ff3b3b}

  .overlay{position:fixed; inset:0; background:radial-gradient(1000px 600px at 40% -10%,rgba(255,59,59,.12),transparent), rgba(0,0,0,.9); display:none; align-items:center; justify-content:center; z-index:30}
  .gate{width:min(520px,92vw); background:#0b0f14; border:2px solid #330; border-radius:16px; padding:18px}
  .gate h3{margin:0 0 6px 0; text-transform:uppercase; letter-spacing:.2em; color:#ff9b9b}
  .denied{color:#ff9b9b; font-weight:900; letter-spacing:.18em; text-transform:uppercase}

  #topBanner{position:fixed; left:0; right:0; top:54px; z-index:25; padding:10px 16px; text-align:center; font-weight:900; letter-spacing:.18em; text-transform:uppercase; border-bottom:2px solid #300; background:#1a0000; color:#ff9b9b; display:none}
  .footer{margin:30px 0 50px; text-align:center; color:#9fb0c9; font-size:12px}
</style>
</head>
<body>
  <header>
    <div class="lcars">
      <div class="bar"></div><div class="bar2"></div>
      <div class="title">LCARS // SELF‑DESTRUCT CONSOLE</div>
      <div class="tabs">
        <button class="tab active" id="tabCountdown">COUNTDOWN</button>
        <button class="tab" id="tabControl">CONTROL</button>
      </div>
    </div>
  </header>

  <div id="topBanner">SELF DESTRUCT SYSTEM DAMAGED — OFFLINE</div>

  <!-- CONTROL pin gate (only when opening CONTROL) -->
  <div id="gateOverlay" class="overlay">
    <div class="gate">
      <h3>ACCESS CONTROL</h3>
      <div class="denied" id="gateLabel">ACCESS DENIED</div>
      <div class="two" style="margin-top:6px">
        <div>
          <label for="pin">Operator PIN</label>
          <input id="pin" type="password" placeholder="Enter PIN" autocomplete="current-password" />
        </div>
        <div style="display:flex; gap:8px; align-items:end">
          <button id="btnUnlock" class="primary">Unlock</button>
          <button id="btnSetPin">Set PIN</button>
        </div>
      </div>
    </div>
  </div>

  <main>
    <!-- COUNTDOWN VIEW (public) -->
    <div id="viewCountdown">
      <section class="centerCard">
        <h2>SELF‑DESTRUCT STATUS</h2>
        <div class="statusRow">
          <span class="k">STATE</span>
          <span id="statusPill" class="pill idle">IDLE</span>
          <span class="k">SINCE</span>
          <span id="since">–</span>
        </div>
        <div class="timer">
          <div class="k">TIME REMAINING</div>
          <div id="timeLeft" class="big">00:00</div>
          <div class="bar"><div id="barFill"></div></div>
          <div class="sub" id="countdownInfo">—</div>
        </div>
      </section>

      <section class="card" style="max-width:min(980px,92vw); margin:0 auto">
        <h2>EVENT LOG</h2>
        <div id="log" class="log"></div>
      </section>
    </div>

    <!-- CONTROL VIEW (PIN‑gated) -->
    <div id="viewControl">
      <section class="card" id="officerSetupSection">
        <h2>OFFICERS — ONE‑TIME SETUP</h2>
        <div class="two">
          <div><label>Officer 1 Name</label><input id="setupO1Name" placeholder="Name" /></div>
          <div><label>Officer 1 PIN</label><input id="setupO1Pin" type="password" placeholder="••••" /></div>
        </div>
        <div class="two" style="margin-top:8px">
          <div><label>Officer 2 Name</label><input id="setupO2Name" placeholder="Name" /></div>
          <div><label>Officer 2 PIN</label><input id="setupO2Pin" type="password" placeholder="••••" /></div>
        </div>
        <div style="display:flex; gap:8px; margin-top:12px">
          <button id="btnSaveOfficers" class="warn">Save Officers</button>
        </div>
      </section>

      <section class="card" id="officerLockedMsg" style="display:none">
        <h2>OFFICERS</h2>
        <p>SET & LOCKED</p>
      </section>

      <section class="card">
        <h2>ARMING — VERIFY</h2>
        <div class="two">
          <div><label>Officer 1 Name</label><input id="verifyO1Name" placeholder="Enter O1 name" /></div>
          <div><label>Officer 1 PIN</label><input id="verifyO1Pin" type="password" placeholder="••••" /></div>
        </div>
        <div class="two" style="margin-top:8px">
          <div><label>Officer 2 Name</label><input id="verifyO2Name" placeholder="Enter O2 name" /></div>
          <div><label>Officer 2 PIN</label><input id="verifyO2Pin" type="password" placeholder="••••" /></div>
        </div>
        <div style="display:flex; gap:8px; margin-top:10px">
          <button id="btnArm" class="warn">Arm</button>
          <button id="btnDisarm">Disarm</button>
        </div>
      </section>

      <section class="card">
        <h2>COUNTDOWN</h2>
        <div class="two">
          <div><label>Minutes</label><input id="mins" type="number" min="0" value="10"></div>
          <div><label>Seconds</label><input id="secs" type="number" min="0" max="59" value="0"></div>
        </div>
        <div style="display:flex; gap:8px; margin-top:12px">
          <button id="btnStart" class="primary">Start (MARK)</button>
          <button id="btnAbort" class="danger">Abort</button>
          <button id="btnReset">Reset</button>
        </div>
      </section>
    </div>

    <div class="footer">LCARS single‑file · Firebase Realtime DB · Control gated by PIN · Countdown public</div>
  </main>

<!-- Drop-in replacement for your <script type="module">…</script>. Adds:
 - Fullscreen OFFLINE overlay (kept)
 - Voice announcements (arming, mark, detonation)
 - Klaxon alarm loops for ARMED/COUNTDOWN/OFFLINE
 - Last-5-seconds spoken countdown
 - Injects Enable Sound + tick controls if missing
-->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
  import { getDatabase, ref, onValue, update, set, get } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

  // ==== CONFIG: keep your real values here
  const firebaseConfig = {
    apiKey: "AIzaSyCbXxL7mv9U10MxYkdNsVQrijrpsVGoGU0",
    authDomain: "self-destruct-console.firebaseapp.com",
    databaseURL: "https://self-destruct-console-default-rtdb.europe-west1.firebasedatabase.app/",
    projectId: "self-destruct-console",
    storageBucket: "self-destruct-console.firebasestorage.app",
    messagingSenderId: "669939099742",
    appId: "1:669939099742:web:310269ae940dd68a84accf"
  };

  // ==== Helpers
  const $ = s => document.querySelector(s);
  const now = () => Date.now();
  const fmt = {
    hhmmss(ms){ if(ms<0) ms=0; const t=Math.floor(ms/1000); const h=Math.floor(t/3600), m=Math.floor((t%3600)/60), s=t%60; const pad=n=>String(n).padStart(2,'0'); return (h>0?pad(h)+':':'')+pad(m)+':'+pad(s); },
    when(ts){ return ts? new Date(ts).toLocaleString(): '–'; }
  };
  const norm = s => (s||'').trim().replace(/\s+/g,' ').toLowerCase();
  const qs = new URLSearchParams(location.search);
  const FORCE_OFFLINE = qs.has('offline');

  // ==== Big fullscreen OFFLINE overlay + styles
  const style = document.createElement('style');
  style.textContent = `
    #globalAlert{position:fixed;inset:0;display:none;z-index:10000;background:radial-gradient(1200px 700px at 30% -10%, rgba(255,0,0,.18), transparent),radial-gradient(1200px 700px at 70% 110%, rgba(255,0,0,.12), transparent),repeating-linear-gradient(90deg, rgba(255,0,0,.08) 0 6px, transparent 6px 12px),rgba(10,0,0,.92);backdrop-filter:blur(2px);align-items:center;justify-content:center}
    #globalAlert .msg{font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;text-transform:uppercase;letter-spacing:.18em;text-align:center;font-weight:900;line-height:1.1;font-size:clamp(32px,7vw,120px);color:#ff6b6b;text-shadow:0 0 8px #ff2a2a,0 0 18px #ff2a2a,0 0 36px #ff2a2a,0 0 60px rgba(255,0,0,.45);animation:alarmPulse 1.2s ease-in-out infinite,alarmGlow 2.4s ease-in-out infinite}
    #globalAlert .sub{margin-top:14px;font-size:clamp(12px,1.6vw,18px);color:#ffb3b3;opacity:.9;letter-spacing:.14em}
    @keyframes alarmPulse{0%{opacity:.35}50%{opacity:1}100%{opacity:.35}}
    @keyframes alarmGlow{0%{text-shadow:0 0 8px #ff2a2a,0 0 18px #ff2a2a,0 0 36px #ff2a2a,0 0 60px rgba(255,0,0,.45)}50%{text-shadow:0 0 12px #ff3f3f,0 0 24px #ff3f3f,0 0 48px #ff3f3f,0 0 80px rgba(255,0,0,.6)}100%{text-shadow:0 0 8px #ff2a2a,0 0 18px #ff2a2a,0 0 36px #ff2a2a,0 0 60px rgba(255,0,0,.45)}}
    #topBanner{position:fixed;left:0;right:0;top:0;z-index:9999;padding:12px 16px;text-align:center;font-weight:900;letter-spacing:.18em;text-transform:uppercase;border-bottom:2px solid #300;background:#1a0000;color:#ff9b9b;display:none}
  `;
  document.head.appendChild(style);
  let alarm = document.getElementById('globalAlert');
  if(!alarm){ alarm = document.createElement('div'); alarm.id='globalAlert'; alarm.innerHTML = `<div class="msg">SELF DESTRUCT SYSTEM DAMAGED — OFFLINE<div class="sub">Firebase unreachable · controls disabled</div></div>`; document.body.appendChild(alarm); }
  let banner = document.getElementById('topBanner');
  if(!banner){ banner = document.createElement('div'); banner.id='topBanner'; banner.textContent='SELF DESTRUCT SYSTEM DAMAGED — OFFLINE'; document.body.prepend(banner); }
  const showAlarm=(main='SELF DESTRUCT SYSTEM DAMAGED — OFFLINE', sub='Firebase unreachable · controls disabled')=>{ alarm.querySelector('.msg').firstChild.nodeValue = main; alarm.querySelector('.sub').textContent=sub; alarm.style.display='flex'; };
  const hideAlarm=()=>{ alarm.style.display='none'; };
  const showBanner=(txt)=>{ banner.textContent=txt||'SELF DESTRUCT SYSTEM DAMAGED — OFFLINE'; banner.style.display='block'; };
  const hideBanner=()=>{ banner.style.display='none'; };

  // ==== refs
  const statusPill=$('#statusPill'), sinceEl=$('#since'), timeLeftEl=$('#timeLeft'), barFill=$('#barFill'), countdownInfoEl=$('#countdownInfo'), logEl=$('#log');
  const tabCountdown=$('#tabCountdown'), tabControl=$('#tabControl');
  const vCountdown=$('#viewCountdown'), vControl=$('#viewControl');
  const gateOverlay=$('#gateOverlay'), gateLabel=$('#gateLabel');
  const btnSetPin=$('#btnSetPin'), btnUnlock=$('#btnUnlock');
  const btnSaveOfficers=$('#btnSaveOfficers'), btnArm=$('#btnArm'), btnDisarm=$('#btnDisarm'), btnStart=$('#btnStart'), btnAbort=$('#btnAbort'), btnReset=$('#btnReset');
  const officerSetupSection=$('#officerSetupSection'), officerLockedMsg=$('#officerLockedMsg');

  function show(tab){ if(tab==='control'){ vControl.style.display='grid'; vCountdown.style.display='none'; tabControl.classList.add('active'); tabCountdown.classList.remove('active'); if(!unlocked) gateOverlay.style.display='flex'; } else { vCountdown.style.display='grid'; vControl.style.display='none'; tabCountdown.classList.add('active'); tabControl.classList.remove('active'); gateOverlay.style.display='none'; } }
  tabCountdown?.addEventListener('click',()=>show('countdown'));
  tabControl?.addEventListener('click',()=>show('control'));

  // ==== Audio (synth, tick, klaxon, TTS)
  let audioEnabled=false, tickEnabled=true, audioCtx=null;
  function ensureSoundControls(){
    if(document.getElementById('btnToggleSound')) return;
    const t = document.querySelector('.centerCard .timer');
    if(!t) return;
    t.insertAdjacentHTML('afterend', `<div style="margin-top:10px;display:flex;gap:12px;justify-content:center;align-items:center"><button id="btnToggleSound">Enable Sound</button><label style="font-size:12px;color:#9fb0c9"><input id="chkTick" type="checkbox" checked> tick each second</label></div>`);
    document.getElementById('btnToggleSound').addEventListener('click',()=>{ audioEnabled=!audioEnabled; if(audioEnabled && !audioCtx){ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); } document.getElementById('btnToggleSound').textContent = audioEnabled? 'Disable Sound':'Enable Sound'; updateAlarmForState(); });
    document.getElementById('chkTick').addEventListener('change',e=> tickEnabled=e.target.checked);
  }
  ensureSoundControls();

  function speak(text){ if(!audioEnabled) return; const u=new SpeechSynthesisUtterance(text); u.rate=1; u.pitch=1; const vs=speechSynthesis.getVoices(); const pref=vs.find(v=>/en-GB|en-US/i.test(v.lang))||vs[0]; if(pref) u.voice=pref; speechSynthesis.speak(u); }
  function beep(d=120,f=880,v=0.05){ if(!audioEnabled||!audioCtx) return; const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.value=f; g.gain.value=v; o.connect(g).connect(audioCtx.destination); o.start(); setTimeout(()=>o.stop(), d); }

  // Klaxon loop
  let alarmTimer=null, alarmKind=null;
  function startKlaxon(kind){ if(!audioEnabled) return; stopKlaxon(); if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); alarmKind=kind; const period = kind==='countdown'? 800 : kind==='armed'? 1100 : 1000; alarmTimer=setInterval(()=>{
      const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='sawtooth'; g.gain.value=0; o.connect(g).connect(audioCtx.destination);
      const t=audioCtx.currentTime; const f1= kind==='offline'? 300 : kind==='armed'? 420 : 620; const f2= kind==='offline'? 220 : kind==='armed'? 520 : 880;
      o.frequency.setValueAtTime(f1,t); g.gain.linearRampToValueAtTime(0.10,t+0.05); o.frequency.exponentialRampToValueAtTime(f2,t+0.60); g.gain.linearRampToValueAtTime(0.0,t+0.70); o.start(t); o.stop(t+0.72);
    }, period);
  }
  function stopKlaxon(){ if(alarmTimer){ clearInterval(alarmTimer); alarmTimer=null; } }
  function updateAlarmForState(){
    let target=null; if(!ONLINE) target='offline'; else if(state.status==='ARMED') target='armed'; else if(state.status==='COUNTDOWN') target='countdown';
    if(target!==alarmKind){ stopKlaxon(); if(target && audioEnabled) startKlaxon(target); alarmKind=target; }
  }

  // ==== App state
  let state = { status:'IDLE', since:now(), auth1:null, auth2:null, startAt:null, durationMs:0, armedAt:null, log:[`[${new Date().toLocaleTimeString()}] Initialized`], controlKeyHash:null };
  let officers = { locked:false, o1:{name:'', nameNorm:'', codeHash:''}, o2:{name:'', nameNorm:'', codeHash:''} };
  let unlocked=false, ONLINE=false;

  function disableControls(dis){ [btnSetPin,btnUnlock,btnSaveOfficers,btnArm,btnDisarm,btnStart,btnAbort,btnReset].forEach(el=>{ if(el) el.disabled = dis; }); }
  let offlineVoiced=false;
  function setOnline(ok, msg){ ONLINE=ok; if(ok){ hideAlarm(); hideBanner(); disableControls(false); offlineVoiced=false; } else { showAlarm(msg||'SELF DESTRUCT SYSTEM DAMAGED — OFFLINE'); showBanner(msg||'SELF DESTRUCT SYSTEM DAMAGED — OFFLINE'); disableControls(true); if(!offlineVoiced){ speak('Warning. Self destruct system damaged. Firebase offline.'); offlineVoiced=true; } }
    updateAlarmForState();
  }

  function render(){
    const s=state.status; statusPill.textContent=s; statusPill.className='pill '+s.toLowerCase(); sinceEl.textContent=fmt.when(state.since);
    if(s==='COUNTDOWN'){
      const T0=state.startAt||0, dur=state.durationMs||0, left=T0+dur-now(); timeLeftEl.textContent=fmt.hhmmss(left); barFill.style.width=Math.max(0,Math.min(100,Math.round(100*(1-left/dur))))+'%'; countdownInfoEl.textContent=`${Math.floor(dur/60000)}m ${(Math.floor(dur/1000)%60).toString().padStart(2,'0')}s from ${new Date(T0).toLocaleTimeString()}`; timeLeftEl.classList.toggle('flash', left<=30000);
    } else if(s==='ARMED'){ timeLeftEl.textContent='— — : — —'; barFill.style.width='0%'; countdownInfoEl.textContent='Awaiting MARK'; timeLeftEl.classList.remove('flash'); }
    else if(s==='DETONATED'){ timeLeftEl.textContent='00:00'; barFill.style.width='100%'; timeLeftEl.classList.remove('flash'); barFill.style.width='100%'; }
    else { timeLeftEl.textContent='00:00'; barFill.style.width='0%'; countdownInfoEl.textContent='—'; timeLeftEl.classList.remove('flash'); }
    logEl.innerHTML=(state.log||[]).slice().reverse().join('\n');
    updateAlarmForState();
  }

  // Timer + last-5 spoken countdown
  let lastSpokenSec=null;
  setInterval(()=>{
    if(state.status==='COUNTDOWN'){
      render();
      const left=(state.startAt||0)+(state.durationMs||0)-now();
      const sec=Math.ceil(left/1000);
      if(tickEnabled && audioEnabled && sec>0 && (sec!==window.__lastSec)){
        window.__lastSec=sec; beep(70, left<=5000?1200: left<=30000?1000:700, left<=30000?0.09:0.05);
      }
      if(audioEnabled && sec<=5 && sec>0 && sec!==lastSpokenSec){ lastSpokenSec=sec; speak(String(sec)); }
      if(left<=0 && state.status!=='DETONATED'){
        setStatus('DETONATED'); appendLog('*** DETONATION ***'); speak('Auto destruct complete. Goodbye.'); stopKlaxon();
      }
      setControlState();
    }
  }, 200);

  // Crypto
  async function sha256(str){ const enc=new TextEncoder().encode(str); const buf=await crypto.subtle.digest('SHA-256', enc); return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join(''); }

  // Config validation
  function validateConfig(){
    const cfg=firebaseConfig; const vals=[cfg.apiKey,cfg.authDomain,cfg.databaseURL,cfg.projectId,cfg.appId];
    if(vals.some(v=>!v||/YOUR_/.test(v)||/YOUR_PROJECT_ID/.test(v)||/YOUR_DB/.test(v))) return 'CONFIG MISSING — OFFLINE';
    try{ const h=new URL(cfg.databaseURL).hostname; if(!/\.firebasedatabase\.app$/i.test(h)) return 'BAD databaseURL — OFFLINE'; }catch{ return 'BAD databaseURL — OFFLINE'; }
    if(!/\.firebaseapp\.com$/i.test(cfg.authDomain)) return 'BAD authDomain — OFFLINE';
    return null;
  }
  function withTimeout(p, ms=6000){ return Promise.race([p, new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),ms))]); }

  // Firebase boot
  let app, db, root, cfgRef;
  (async function init(){
    const cfgErr = validateConfig();
    if(cfgErr || FORCE_OFFLINE){ setOnline(false, cfgErr||'OFFLINE (forced)'); return; }
    try{
      app = initializeApp(firebaseConfig);
      db = getDatabase(app);
      root = ref(db, 'selfDestruct');
      cfgRef  = ref(db, 'selfDestruct/config');

      const s = await withTimeout(get(root), 6000);
      if(!s.exists()) await set(root, state); else state = { ...state, ...s.val() };

      const c = await withTimeout(get(cfgRef), 6000);
      if(c.exists()) { officers = (c.val()||{}).officers || officers; } else { await set(cfgRef, { officers }); }

      onValue(root, snap=>{ const v=snap.val()||{}; state={...state, ...v}; render(); setControlState(); refreshPinUI(); });
      onValue(cfgRef,  snap=>{ const v=snap.val()||{}; officers = v.officers? v.officers : officers; updateOfficerUI(); });

      const connectedRef = ref(db, '.info/connected');
      onValue(connectedRef, snap=>{ setOnline(snap.val()===true); });

      setOnline(true);
    }catch(err){ console.error('[Firebase error]', err); setOnline(false, 'FIREBASE ERROR — OFFLINE'); }
  })();

  // DB helpers
  function assertOnline(){ if(!ONLINE) throw new Error('OFFLINE'); }
  async function write(patch){ assertOnline(); return update(root, patch); }
  async function writeCfg(patch){ assertOnline(); return update(cfgRef, patch); }
  async function appendLog(line){ try{ const e=`[${new Date().toLocaleTimeString()}] ${line}`; state.log=(state.log||[]).slice(-99).concat(e); await write({ log: state.log }); }catch(_){} }
  function setStatus(s){ try{ assertOnline(); return update(root, { status:s, since: now() }); }catch(_){ return; } }

  // PIN
  function refreshPinUI(){ if(state.controlKeyHash){ if(btnSetPin) btnSetPin.style.display='none'; } else { if(btnSetPin) btnSetPin.style.display='inline-block'; } }
  btnSetPin?.addEventListener('click', async ()=>{
    if(!ONLINE) return alert('System offline. Check Firebase configuration.');
    if(state.controlKeyHash){ alert('PIN already set.'); return; }
    const pin=$('#pin').value.trim(); if(!pin) return alert('Enter a PIN first.');
    const hash=await sha256(pin); await write({ controlKeyHash: hash }); await appendLog('Operator PIN set.'); refreshPinUI(); speak('Operator PIN set.');
  });
  btnUnlock?.addEventListener('click', async ()=>{
    if(!ONLINE) return alert('System offline.');
    const pin=$('#pin').value.trim(); if(!pin) return;
    if(!state.controlKeyHash) return alert('No PIN set yet.');
    const ok=(await sha256(pin))===state.controlKeyHash; if(!ok){ gateLabel.textContent='ACCESS DENIED'; gateLabel.style.color='#ff9b9b'; return; }
    unlocked=true; gateLabel.textContent='ACCESS GRANTED'; gateLabel.style.color='#2be4a1'; gateOverlay.style.display='none'; setControlState(); speak('Access granted.'); updateAlarmForState();
  });

  // Officers
  const officersAreLocked = ()=> !!(officers && officers.locked && officers.o1?.codeHash && officers.o2?.codeHash);
  function updateOfficerUI(){ if(officersAreLocked()){ officerSetupSection.style.display='none'; officerLockedMsg.style.display='block'; } else { officerSetupSection.style.display='block'; officerLockedMsg.style.display='none'; } }
  btnSaveOfficers?.addEventListener('click', async ()=>{
    if(!ONLINE) return alert('System offline.');
    if(!unlocked) return alert('Unlock CONTROL first.');
    if(officersAreLocked()){ alert('Officers already set.'); return; }
    const n1=$('#setupO1Name').value.trim(); const p1=$('#setupO1Pin').value.trim();
    const n2=$('#setupO2Name').value.trim(); const p2=$('#setupO2Pin').value.trim();
    if(!n1||!p1||!n2||!p2) return alert('Enter both names and pins.');
    const o = { locked:true, o1:{ name:n1, nameNorm:norm(n1), codeHash: await sha256(p1) }, o2:{ name:n2, nameNorm:norm(n2), codeHash: await sha256(p2) } };
    await writeCfg({ officers:o }); officers=o; updateOfficerUI(); await appendLog('Officers set.'); speak('Officer credentials stored.');
  });

  // Controls
  btnArm?.addEventListener('click', async ()=>{
    if(!ONLINE) return alert('System offline.');
    if(!unlocked) return; if(state.status!=='IDLE') return alert('Must be IDLE to arm.'); if(!officersAreLocked()) return alert('Set officers first.');
    const n1 = norm($('#verifyO1Name').value), p1=$('#verifyO1Pin').value.trim();
    const n2 = norm($('#verifyO2Name').value), p2=$('#verifyO2Pin').value.trim();
    if(!n1||!n2||!p1||!p2) return alert('Enter both names and pins.');
    const ok1 = (n1===officers.o1.nameNorm) && (await sha256(p1)===officers.o1.codeHash);
    const ok2 = (n2===officers.o2.nameNorm) && (await sha256(p2)===officers.o2.codeHash);
    if(!(ok1 && ok2)) { alert('Verification failed.'); return; }
    await write({auth1:{at:now()}, auth2:{at:now()}, armedAt:now()}); await setStatus('ARMED'); await appendLog('Armed by two officers.');
    // Voice sequence (no names)
    speak('Computer. Authorization one confirmed.'); setTimeout(()=> speak('Identity confirmed. Additional authorization required.'), 1200); setTimeout(()=> speak('Computer. Authorization two confirmed.'), 3000); setTimeout(()=> speak('Identity confirmed. Auto destruct sequence armed.'), 4800);
    updateAlarmForState(); setControlState();
  });
  btnDisarm?.addEventListener('click', async ()=>{ if(!ONLINE) return alert('System offline.'); if(!unlocked) return; await write({auth1:null, auth2:null, armedAt:null}); await setStatus('IDLE'); await appendLog('Disarmed.'); speak('Auto destruct disarmed.'); stopKlaxon(); setControlState(); });

  btnStart?.addEventListener('click', async ()=>{
    if(!ONLINE) return alert('System offline.'); if(!unlocked) return; if(state.status!=='ARMED') return alert('Arm first.');
    const m=Math.max(0, parseInt($('#mins').value||'0',10)); const s=Math.max(0, Math.min(59, parseInt($('#secs').value||'0',10)));
    const durationMs=(m*60+s)*1000; const startAt=now();
    await write({startAt, durationMs}); await setStatus('COUNTDOWN'); await appendLog(`MARK — countdown started: ${m}m ${s}s.`);
    speak(`Set the countdown for ${m} minutes ${s} seconds from my mark. Mark.`); setTimeout(()=> speak(`Sequence initiated. Auto destruct in ${m} minutes ${s} seconds.`), 1300);
    updateAlarmForState(); setControlState();
  });

  btnAbort?.addEventListener('click', async ()=>{
    if(!ONLINE) return alert('System offline.'); if(!unlocked) return; if(state.status!=='COUNTDOWN') return;
    const left = (state.startAt||0)+(state.durationMs||0)-now(); if(left <= 15000){ await appendLog('Abort rejected — inside T‑15s.'); return; }
    await setStatus('ABORTED'); await appendLog('*** ABORTED ***'); speak('Auto destruct sequence aborted.'); stopKlaxon(); setControlState();
  });

  btnReset?.addEventListener('click', async ()=>{
    if(!ONLINE) return alert('System offline.'); if(!unlocked) return; const newState = { status:'IDLE', since:now(), auth1:null, auth2:null, startAt:null, durationMs:0, armedAt:null, controlKeyHash: state.controlKeyHash || null, log:[`[${new Date().toLocaleTimeString()}] Reset by operator`] };
    await set(root, newState); await writeCfg({ officers }); speak('System reset to idle.'); stopKlaxon(); setControlState();
  });

  function setControlState(){
    const left = (state.startAt||0)+(state.durationMs||0)-now();
    if(btnArm)   btnArm.disabled   = !ONLINE || !unlocked || state.status!=='IDLE';
    if(btnDisarm)btnDisarm.disabled= !ONLINE || !unlocked || !(state.status==='ARMED');
    if(btnStart) btnStart.disabled = !ONLINE || !unlocked || !(state.status==='ARMED');
    if(btnAbort) btnAbort.disabled = !ONLINE || !unlocked || !(state.status==='COUNTDOWN') || left<=15000;
    if(btnReset) btnReset.disabled = !ONLINE || !unlocked || !(['ABORTED','DETONATED'].includes(state.status));
    if(btnSaveOfficers) btnSaveOfficers.disabled = !ONLINE || !unlocked || officersAreLocked();
  }

  // Initial render
  render();
</script>

