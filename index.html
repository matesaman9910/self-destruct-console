<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LCARS Self-Destruct Console v5.2</title>
<style>
:root{
  --bg:#070709;--text:#eef3ff;--muted:#9fb0c9;--line:#262a34;
  --lcars-amber:#ffb400;--lcars-red:#ff3b3b;
  --ok:#2be4a1;--warn:#ffb400;--alert:#ff4b4b;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
header{position:sticky;top:0;z-index:20;padding:10px 14px;background:linear-gradient(180deg,#0e1118,#0a0c11);border-bottom:2px solid var(--line)}
.lcars{display:flex;align-items:center;gap:14px}
.lcars .bar{height:24px;width:160px;border-radius:12px 0 0 12px;background:var(--lcars-amber)}
.lcars .bar2{height:24px;width:110px;border-radius:0 12px 12px 0;background:var(--lcars-red)}
.title{letter-spacing:.28em;text-transform:uppercase;font-weight:900}
.tabs{margin-left:auto;display:flex;gap:8px}
.tab{cursor:pointer;padding:12px 16px;border:2px solid var(--line);background:#131722;border-radius:999px;color:#dde7ff;font-weight:800;letter-spacing:.08em}
.tab.active{background:linear-gradient(90deg,#2a0000,#4a0000);border-color:#a22;color:#fff}
main{max-width:1200px;margin:0 auto;padding:22px}

/* COUNTDOWN view */
#viewCountdown{display:grid;grid-template-columns:1fr;gap:18px}
.centerCard{background:linear-gradient(180deg,#161b28,#111621);border:1px solid #202c3d;border-radius:18px;padding:22px;display:flex;flex-direction:column;align-items:center;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.35)}
.centerCard h2{margin:0 0 12px;letter-spacing:.12em;text-transform:uppercase}
.statusRow{display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap}
.pill{padding:6px 14px;border-radius:999px;font-weight:900;letter-spacing:.1em}
.idle{background:#0b241a;color:var(--ok);border:1px solid #1b5c44}
.armed{background:#241f0b;color:var(--warn);border:1px solid #6b560d}
.countdown{background:#2a0b0b;color:var(--alert);border:1px solid #6b2323}
.aborted{background:#1e1e1e;color:#cfcfcf;border:1px solid #3a3a3a}
.detonated{background:#360909;color:#ff9b9b;border:1px solid #833}
.k{color:#9fb0c9;text-transform:uppercase;letter-spacing:.12em;font-size:13px}
.timer{display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:14px}
.big{font-variant-numeric:tabular-nums;font-size:96px;line-height:1;letter-spacing:.04em}
.sub{color:#9fb0c9;font-size:14px}
.bar{height:18px;background:#101827;border:1px solid #1f2d44;border-radius:999px;overflow:hidden;width:min(900px,92vw);margin-top:12px}
.bar>div{height:100%;width:0%;background:linear-gradient(90deg,var(--ok),var(--warn),var(--alert));transition:width .2s linear}
.log{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b0f18;border:1px solid #1b2740;border-radius:14px;padding:12px;height:220px;overflow:auto}
.flash{animation:flash .8s steps(4) infinite}
@keyframes flash{50%{opacity:.35}}

/* CONTROL view */
#viewControl{display:none;grid-template-columns:1fr 1fr;gap:18px}
.card{background:linear-gradient(180deg,#161b28,#111621);border:1px solid #202c3d;border-radius:18px;padding:18px}
.card h2{margin:0 0 12px;letter-spacing:.12em;text-transform:uppercase}
.two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
input{background:#0f1421;border:1px solid #203049;color:#eaf2ff;padding:12px;border-radius:12px;width:100%}
label{display:block;font-size:12px;color:#9fb0c9;margin-bottom:6px}
button{cursor:pointer;padding:12px 14px;border-radius:12px;border:1px solid #2a3b56;background:#0f1623;color:#e6eefb;font-weight:800}
button.primary{border-color:#21d39e}
button.warn{border-color:#ffb400}
button.danger{border-color:#ff3b3b}
.footer{margin:28px 0 50px;text-align:center;color:#9fb0c9;font-size:12px}

/* access gate */
.overlay{position:fixed;inset:0;background:radial-gradient(1000px 600px at 40% -10%,rgba(255,59,59,.12),transparent), rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:30}
.gate{width:min(520px,92vw);background:#0b0f14;border:2px solid #330;border-radius:16px;padding:18px}
.gate h3{margin:0 0 6px;text-transform:uppercase;letter-spacing:.2em;color:#ff9b9b}
.denied{color:#ff9b9b;font-weight:900;letter-spacing:.18em;text-transform:uppercase}

/* alerts */
#globalAlert{position:fixed;inset:0;display:none;z-index:10000;
  background:
  radial-gradient(1200px 700px at 30% -10%, rgba(255,0,0,.18), transparent),
  radial-gradient(1200px 700px at 70% 110%, rgba(255,0,0,.12), transparent),
  repeating-linear-gradient(90deg, rgba(255,0,0,.08) 0 6px, transparent 6px 12px),
  rgba(10,0,0,.92);backdrop-filter:blur(2px);
  align-items:center;justify-content:center}
#globalAlert .msg{font-family:inherit;text-transform:uppercase;letter-spacing:.18em;text-align:center;font-weight:900;line-height:1.1;
  font-size:clamp(32px,7vw,120px);color:#ff6b6b;
  text-shadow:0 0 8px #ff2a2a,0 0 18px #ff2a2a,0 0 36px #ff2a2a,0 0 60px rgba(255,0,0,.45);
  animation:alarmPulse 1.2s ease-in-out infinite,alarmGlow 2.4s ease-in-out infinite}
#globalAlert .sub{margin-top:14px;font-size:clamp(12px,1.6vw,18px);color:#ffb3b3;opacity:.9;letter-spacing:.14em}
@keyframes alarmPulse{0%{opacity:.35}50%{opacity:1}100%{opacity:.35}}
@keyframes alarmGlow{0%{text-shadow:0 0 8px #ff2a2a,0 0 18px #ff2a2a,0 0 36px #ff2a2a,0 0 60px rgba(255,0,0,.45)}
50%{text-shadow:0 0 12px #ff3f3f,0 0 24px #ff3f3f,0 0 48px #ff3f3f,0 0 80px rgba(255,0,0,.6)}
100%{text-shadow:0 0 8px #ff2a2a,0 0 18px #ff2a2a,0 0 36px #ff2a2a,0 0 60px rgba(255,0,0,.45)}}
#topBanner{position:fixed;left:0;right:0;top:54px;z-index:25;padding:10px 16px;text-align:center;font-weight:900;letter-spacing:.18em;text-transform:uppercase;border-bottom:2px solid #300;background:#1a0000;color:#ff9b9b;display:none}
#cornerToasts{position:fixed;right:12px;bottom:12px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{background:#220;border:1px solid #933;color:#fbb;padding:8px 10px;border-radius:10px;font-weight:800;letter-spacing:.1em;text-transform:uppercase}
</style>
</head>
<body>
<header>
  <div class="lcars">
    <div class="bar"></div><div class="bar2"></div>
    <div class="title">LCARS // SELF-DESTRUCT CONSOLE</div>
    <div class="tabs">
      <button class="tab active" id="tabCountdown">COUNTDOWN</button>
      <button class="tab" id="tabControl">CONTROL</button>
    </div>
  </div>
</header>

<div id="topBanner">SELF DESTRUCT SYSTEM DAMAGED — OFFLINE</div>
<div id="globalAlert"><div class="msg"><span id="alarmMain">ALERT</span><div id="alarmSub" class="sub"></div></div></div>
<div id="cornerToasts"></div>

<!-- CONTROL gate -->
<div id="gateOverlay" class="overlay">
  <div class="gate">
    <h3>ACCESS CONTROL</h3>
    <div class="denied" id="gateLabel">ACCESS DENIED</div>
    <div class="two" style="margin-top:6px">
      <div>
        <label for="pin">Operator PIN</label>
        <input id="pin" type="password" placeholder="Enter PIN" autocomplete="current-password"/>
      </div>
      <div style="display:flex;gap:8px;align-items:end">
        <button id="btnUnlock" class="primary">Unlock</button>
        <button id="btnSetPin">Set PIN</button>
      </div>
    </div>
  </div>
</div>

<main>
  <!-- COUNTDOWN VIEW -->
  <div id="viewCountdown">
    <section class="centerCard">
      <h2>SELF-DESTRUCT STATUS</h2>
      <div class="statusRow">
        <span class="k">STATE</span><span id="statusPill" class="pill idle">IDLE</span>
        <span class="k">SINCE</span><span id="since">–</span>
      </div>
      <div class="timer">
        <div class="k">TIME REMAINING</div>
        <div id="timeLeft" class="big">00:00</div>
        <div class="bar"><div id="barFill"></div></div>
        <div class="sub" id="countdownInfo">—</div>
      </div>
      <div style="margin-top:10px;display:flex;gap:12px;justify-content:center;align-items:center">
        <button id="btnToggleSound">Enable Sound</button>
        <label style="font-size:12px;color:#9fb0c9"><input id="chkTick" type="checkbox" checked> tick each second</label>
      </div>
    </section>

    <section class="card" style="max-width:min(980px,92vw);margin:0 auto">
      <h2>EVENT LOG</h2>
      <div id="log" class="log"></div>
    </section>
  </div>

  <!-- CONTROL VIEW -->
  <div id="viewControl">
    <section class="card" id="operatorCard">
      <h2>OPERATOR DEVICE</h2>
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <div><span class="k">UID</span> <code id="uidVal">—</code></div>
        <div class="pill" style="padding:4px 10px" id="opStatus">VIEWER DEVICE</div>
        <button id="btnCopyUid">Copy UID</button>
        <button id="btnSetAsOperator">Set this device as operator</button>
        <button id="btnResetOperator" class="danger">Reset operator (set null)</button>
      </div>
      <p class="muted" style="margin-top:6px;color:#9fb0c9">Only the current operator device can reset. After reset, the next signed-in device can claim operator.</p>
    </section>

    <section class="card" id="rekeyCard">
      <h2>REKEY OFFICERS (BREAK-GLASS)</h2>
      <div class="two">
        <div><label>Operator PIN</label><input id="rkPin" type="password" placeholder="••••"/></div>
        <div><label>Recovery Token</label><input id="rkToken" type="password" placeholder="Paste long token"/></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
        <button id="btnGenToken">Generate token</button>
        <button id="btnSetRecovery" class="warn">Set / Rotate Recovery Token</button>
        <button id="btnRekey" class="danger">Rekey Officers</button>
      </div>
      <p class="muted" style="margin-top:6px;color:#9fb0c9">Token is single-use; only the hash is stored.</p>
    </section>

    <section class="card" id="officerSetupSection">
      <h2>OFFICERS — ONE-TIME SETUP</h2>
      <div class="two">
        <div><label>Officer 1 Name</label><input id="setupO1Name" placeholder="Name"/></div>
        <div><label>Officer 1 PIN</label><input id="setupO1Pin" type="password" placeholder="••••"/></div>
      </div>
      <div class="two" style="margin-top:8px">
        <div><label>Officer 2 Name</label><input id="setupO2Name" placeholder="Name"/></div>
        <div><label>Officer 2 PIN</label><input id="setupO2Pin" type="password" placeholder="••••"/></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="btnSaveOfficers" class="warn">Save Officers</button>
      </div>
    </section>

    <section class="card" id="officerLockedMsg" style="display:none">
      <h2>OFFICERS</h2><p>SET & LOCKED</p>
    </section>

    <section class="card">
      <h2>ARMING — VERIFY</h2>
      <div class="two">
        <div><label>Officer 1 Name</label><input id="verifyO1Name" placeholder="Enter O1 name"/></div>
        <div><label>Officer 1 PIN</label><input id="verifyO1Pin" type="password" placeholder="••••"/></div>
      </div>
      <div class="two" style="margin-top:8px">
        <div><label>Officer 2 Name</label><input id="verifyO2Name" placeholder="Enter O2 name"/></div>
        <div><label>Officer 2 PIN</label><input id="verifyO2Pin" type="password" placeholder="••••"/></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="btnArm" class="warn">Arm</button>
        <button id="btnDisarm">Disarm</button>
      </div>
    </section>

    <section class="card">
      <h2>COUNTDOWN</h2>
      <div class="two">
        <div><label>Minutes</label><input id="mins" type="number" min="0" value="10"/></div>
        <div><label>Seconds</label><input id="secs" type="number" min="0" max="59" value="0"/></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="btnStart" class="primary">Start (MARK)</button>
        <button id="btnAbort" class="danger">Abort</button>
        <button id="btnReset">Reset</button>
      </div>
    </section>
  </div>

  <div class="footer">LCARS single-file · Firebase Realtime DB · Operator-gated control · Countdown public</div>
</main>

<script type="module">
/* ───────────────── Firebase SDKs ───────────────── */
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
import { getDatabase, ref, child, get, onValue, update, set } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';

/* ───────────────── Config ───────────────── */
const firebaseConfig = {
  apiKey: "AIzaSyCbXxL7mv9U10MxYkdNsVQrijrpsVGoGU0",
  authDomain: "self-destruct-console.firebaseapp.com",
  databaseURL: "https://self-destruct-console-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "self-destruct-console",
  storageBucket: "self-destruct-console.firebasestorage.app",
  messagingSenderId: "669939099742",
  appId: "1:669939099742:web:310269ae940dd68a84accf"
};

/* ───────────────── DOM helpers / alerts (HARDENED) ───────────────── */
const $ = s => document.querySelector(s);
function ensureAlertDOM(){
  if(!document.getElementById('globalAlert')){
    const d=document.createElement('div');
    d.id='globalAlert';
    d.style.cssText='position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;background:rgba(0,0,0,.92)';
    d.innerHTML = `<div style="text-align:center;text-transform:uppercase;letter-spacing:.18em;color:#ff8080;font-weight:900">
                     <div id="alarmMain" style="font-size:clamp(28px,7vw,120px);text-shadow:0 0 24px #f22">ALERT</div>
                     <div id="alarmSub" style="margin-top:8px;font-size:clamp(12px,1.6vw,18px);color:#ffb3b3"></div>
                   </div>`;
    document.body.appendChild(d);
  }
  if(!document.getElementById('topBanner')){
    const b=document.createElement('div');
    b.id='topBanner';
    b.style.cssText='position:fixed;left:0;right:0;top:0;display:none;z-index:9998;padding:10px 16px;text-align:center;border-bottom:2px solid #300;background:#1a0000;color:#ff9b9b;font-weight:900;letter-spacing:.18em;text-transform:uppercase';
    b.textContent='ALERT';
    document.body.prepend(b);
  }
}
function showAlarm(main, sub){
  ensureAlertDOM();
  $('#alarmMain').textContent = main || 'ALERT';
  $('#alarmSub').textContent  = sub || '';
  $('#globalAlert').style.display = 'flex';
}
function hideAlarm(){ ensureAlertDOM(); $('#globalAlert').style.display='none'; }
function showBanner(text){ ensureAlertDOM(); const b=$('#topBanner'); b.textContent=text; b.style.display='block'; }
function hideBanner(){ ensureAlertDOM(); $('#topBanner').style.display='none'; }

/* ───────────────── Local state ───────────────── */
const now = ()=>Date.now();
const pad2 = n=>String(n).padStart(2,'0');
const fmt  = ms=>{ if(ms<0) ms=0; const t=Math.floor(ms/1000), h=Math.floor(t/3600), m=Math.floor((t%3600)/60), s=t%60; return (h?pad2(h)+':':'')+pad2(m)+':'+pad2(s); };

let app, db, auth;
let root, cfgRef, secRef;
let myUid=null, operatorUid=null;
let ONLINE=false, DEBUG_FLAG=true;
let lockoutUntil=0;

let state = {
  status:'IDLE', since:0, startAt:null, durationMs:0, armedAt:null,
  controlKeyHash:null, logPublic:[]
};

/* ───────────────── Minimal UI refs ───────────────── */
const statusPill = $('#statusPill');
const sinceEl    = $('#since');
const timeLeftEl = $('#timeLeft');
const barFill    = $('#barFill');
const infoEl     = $('#countdownInfo');
const logEl      = $('#log');

/* ───────────────── Render ───────────────── */
function render(){
  const s = state.status || 'IDLE';
  if(statusPill){ statusPill.textContent=s; statusPill.className='pill '+s.toLowerCase(); }
  if(sinceEl) sinceEl.textContent = state.since ? new Date(state.since).toLocaleString() : '–';

  if(s==='COUNTDOWN'){
    const left=(state.startAt||0)+(state.durationMs||0)-now();
    if(timeLeftEl) { timeLeftEl.textContent = fmt(left); timeLeftEl.classList.toggle('flash', left<=30000); }
    if(barFill && state.durationMs>0){ barFill.style.width = Math.max(0,Math.min(100, Math.round(100*(1-left/state.durationMs))))+'%'; }
    if(infoEl) infoEl.textContent = `${Math.floor((state.durationMs||0)/60000)}m ${pad2(Math.floor((state.durationMs||0)/1000)%60)}s from ${new Date(state.startAt||0).toLocaleTimeString()}`;
  }else if(s==='ARMED'){
    if(timeLeftEl) { timeLeftEl.textContent='— — : — —'; timeLeftEl.classList.remove('flash'); }
    if(barFill) barFill.style.width='0%';
    if(infoEl) infoEl.textContent='Awaiting MARK';
  }else if(s==='DETONATED'){
    if(timeLeftEl) { timeLeftEl.textContent='00:00'; timeLeftEl.classList.remove('flash'); }
    if(barFill) barFill.style.width='100%';
  }else{
    if(timeLeftEl) { timeLeftEl.textContent='00:00'; timeLeftEl.classList.remove('flash'); }
    if(barFill) barFill.style.width='0%';
    if(infoEl) infoEl.textContent='—';
  }
  if(logEl) logEl.innerHTML = (state.logPublic||[]).slice().reverse().join('\n');
}

/* ───────────────── Online/Offline gates ───────────────── */
function setOnline(ok, msg){
  ONLINE = !!ok;
  if(!ok){
    showAlarm('SELF DESTRUCT SYSTEM DAMAGED — OFFLINE', msg || 'Firebase unreachable · controls disabled');
    showBanner('SELF DESTRUCT SYSTEM DAMAGED — OFFLINE');
  }else{
    hideBanner();
    if(lockoutUntil && now()<lockoutUntil){
      const secs = Math.max(0, Math.ceil((lockoutUntil-now())/1000));
      showAlarm('TERMINAL LOCKOUT', `Security cooldown · ${secs}s remaining`);
    }else{
      hideAlarm();
    }
  }
}

/* ───────────────── Crypto ───────────────── */
async function sha256(str){
  const enc=new TextEncoder().encode(str);
  const buf=await crypto.subtle.digest('SHA-256', enc);
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* ───────────────── Bootstrap & listeners ───────────────── */
(async function init(){
  try{
    console.log('[LCARS] Loaded build: v5.1.4-max-hotfix; 2025-08-29 00:00Z');

    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    await signInAnonymously(auth);

    onAuthStateChanged(auth, u=>{ myUid = u?.uid || null; });

    db = getDatabase(app);
    root   = ref(db, 'selfDestruct');
    cfgRef = child(root, 'config');
    secRef = child(root, 'security');

    // Connection status
    onValue(ref(db,'.info/connected'), s => setOnline(s.val()===true));

    // Seed minimal keys if missing (status/since/logPublic/debug only: allowed in bootstrap)
    try{
      const r = await get(root);
      if(!r.exists()){
        await update(root, {
          status:'IDLE', since: Date.now(), startAt:null, durationMs:0, armedAt:null,
          logPublic:[], debug:true
        });
      }
      const c = await get(cfgRef);
      if(!c.exists()){
        await update(cfgRef, { operatorUid: null });
      }
    }catch(seedingErr){
      // If this fails, rules disallow bootstrap — user will still see ACCESS DENIED below
      console.warn('[seed warning]', seedingErr);
    }

    // Live reads (public)
    onValue(root, snap=>{
      const v=snap.val()||{};
      // Only copy public bits (others are operator-only)
      state.status=v.status||'IDLE';
      state.since=v.since||0;
      state.startAt=v.startAt||null;
      state.durationMs=v.durationMs||0;
      state.armedAt=v.armedAt||null;
      state.logPublic=Array.isArray(v.logPublic)?v.logPublic:[];
      DEBUG_FLAG = !!v.debug;
      render();
    });

    // Lockout channel
    onValue(secRef, snap=>{
      const s=snap.val()||{};
      lockoutUntil = s.lockoutUntil||0;
      if(now()<lockoutUntil) showAlarm('TERMINAL LOCKOUT', `Security cooldown · ${Math.ceil((lockoutUntil-now())/1000)}s remaining`);
      else if(ONLINE) hideAlarm();
    });

    // Config (operator only). Errors are fine for viewers.
    get(cfgRef).then(s=>{
      const v=s.val()||{};
      operatorUid = v.operatorUid ?? null;
    }).catch(()=>{ /* ignore for viewers */ });

  }catch(err){
    console.error('[Firebase error]', err);
    const msg = String(err && (err.message||err));
    if(msg.includes('Permission denied') || msg.includes('PERMISSION_DENIED')){
      // We are online but blocked by rules (likely not operator yet)
      setOnline(true);
      showBanner('ACCESS DENIED — NOT OPERATOR');
    }else{
      setOnline(false, 'FIREBASE ERROR — OFFLINE');
    }
  }
})();

/* ───────────────── DevTools lockout (disabled while debug=true) ───────────────── */
let dtStrikes=0, dtTimer=null;
const devtoolsOpenLikely=()=>{ const T=140; return (window.outerWidth-window.innerWidth>T)||(window.outerHeight-window.innerHeight>T); };
function enterLockout(reason){
  const ttl = 5*60*1000;
  const until = now()+ttl;
  lockoutUntil = until;
  showAlarm('TERMINAL LOCKOUT', `${reason || 'Security cooldown'} · ${Math.ceil(ttl/1000)}s`);
  // fire-and-forget: any signed-in can write under /security
  if(secRef) update(secRef, { lockoutUntil: until, lockoutReason: reason||'LOCKOUT' }).catch(()=>{});
}
function checkDevtools(){
  if(DEBUG_FLAG) return; // bypass in debug
  if(devtoolsOpenLikely()){
    dtStrikes++; clearTimeout(dtTimer); dtTimer=setTimeout(()=>dtStrikes=0,5000);
    if(dtStrikes>=2) enterLockout('Developer tools opened');
  }
}
setInterval(checkDevtools, 1200);
window.addEventListener('resize', checkDevtools);
window.addEventListener('keydown', e=>{
  if(((e.ctrlKey||e.metaKey)&&e.shiftKey&&(e.key==='I'||e.key==='J'||e.key==='C'))||e.key==='F12') checkDevtools();
});

/* ───────────────── Timer tick ───────────────── */
setInterval(()=>{
  if(state.status==='COUNTDOWN') render();
}, 250);
</script>
